{% extends "base.html" %}
{% block title %}Recalculate Standings{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Recalculate Standings (League Rules)</h1>
  <form method="POST" action="{{ url_for('admin.recalculate_standings') }}">
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="league_id">League</label>
        <select class="form-control" id="league_id" name="league_id" required>
          {% for l in leagues %}
            <option value="{{ l[0] }}">{{ l[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group col-md-4">
        <label for="season_id">Season</label>
        <select class="form-control" id="season_id" name="season_id" required>
          {% for s in seasons %}
            <option value="{{ s[0] }}" data-league="{{ s[2] }}">{{ s[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group col-md-4">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="save" name="save">
          <label class="form-check-label" for="save">Save to standings table</label>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Calculate</button>
  </form>
  {% if results %}
  <hr>
  <h4 class="mt-3">Results{% if league_id %} · League {{ league_id }}{% endif %}{% if season_id %} · Season {{ season_id }}{% endif %}</h4>
  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Pos</th>
          <th>Team</th>
          <th>MP</th>
          <th>W</th>
          <th>D</th>
          <th>L</th>
          <th>GF</th>
          <th>GA</th>
          <th>GD</th>
          <th>Pts</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results %}
        <tr>
          <td>{{ r.position }}</td>
          <td>{{ r.team_name }}</td>
          <td>{{ r.played_games }}</td>
          <td>{{ r.won }}</td>
          <td>{{ r.draw }}</td>
          <td>{{ r.lost }}</td>
          <td>{{ r.goals_for }}</td>
          <td>{{ r.goals_against }}</td>
          <td>{{ r.goal_difference }}</td>
          <td><strong>{{ r.points }}</strong></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
<script>
  (function(){
    const leagueSel = document.getElementById('league_id');
    const seasonSel = document.getElementById('season_id');
    function filter(){
      const lid = leagueSel.value;
      for (const opt of seasonSel.options) {
        if (!opt.value) continue;
        const match = !opt.dataset.league || opt.dataset.league === lid;
        opt.hidden = !match;
      }
      for (const opt of seasonSel.options) { if (!opt.hidden) { seasonSel.value = opt.value; break; } }
    }
    if (leagueSel && seasonSel) {
      leagueSel.addEventListener('change', filter);
      filter();
    }
  })();
</script>
{% endblock %}

