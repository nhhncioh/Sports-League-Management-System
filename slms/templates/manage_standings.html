{% extends "base.html" %}
{% block title %}Manage Standings - Admin Panel{% endblock %}
{% block content %}
<div class="container py-4">
    <!-- Header with Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Manage Standings</h1>
            <p class="text-muted mb-0">Manage individual team standings and configure display settings.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#configureDisplayModal">
                <i class="ph ph-gear-six"></i> Configure Display
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importStandingsModal">
                <i class="ph ph-upload"></i> Import Data
            </button>
            <button type="button" class="btn btn-success" onclick="recalculateStandings()">
                <i class="ph ph-calculator"></i> Auto-Calculate
            </button>
        </div>
    </div>

    <!-- Quick Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Teams</h6>
                            <h4 class="mb-0">{{ standings|length if standings else 0 }}</h4>
                        </div>
                        <i class="ph ph-users fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Games</h6>
                            <h4 class="mb-0">{{ total_games or 0 }}</h4>
                        </div>
                        <i class="ph ph-soccer-ball fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Top Team</h6>
                            <h4 class="mb-0 small">{{ standings[0][2] if standings else 'N/A' }}</h4>
                        </div>
                        <i class="ph ph-trophy fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Last Updated</h6>
                            <h4 class="mb-0 small">{{ last_updated or 'Never' }}</h4>
                        </div>
                        <i class="ph ph-clock fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card shadow-sm border-0">
                <div class="card-header">
                    <h5 class="mb-0" id="form-title">
                        <i class="ph ph-plus-circle me-2"></i>Add Team Standing
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin.manage_standings') }}" method="POST" id="standing-form">
                        <input type="hidden" id="standing_id" name="standing_id">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="team_id" class="form-label">Team *</label>
                                <select class="form-select" id="team_id" name="team_id" required>
                                    <option value="">Choose a team...</option>
                                    {% for team in teams %}
                                    <option value="{{ team[0] }}">{{ team[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="position" class="form-label">Position</label>
                                <input type="number" class="form-control" id="position" name="position" min="1" placeholder="Auto-calculated">
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label for="played_games" class="form-label">Games Played *</label>
                                <input type="number" class="form-control" id="played_games" name="played_games" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="won" class="form-label">Wins *</label>
                                <input type="number" class="form-control" id="won" name="won" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="draw" class="form-label">Draws</label>
                                <input type="number" class="form-control" id="draw" name="draw" min="0" value="0">
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label for="lost" class="form-label">Losses *</label>
                                <input type="number" class="form-control" id="lost" name="lost" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="points" class="form-label">Points</label>
                                <input type="number" class="form-control" id="points" name="points" min="0" placeholder="Auto-calculated">
                            </div>
                            <div class="col-md-4">
                                <label for="goal_difference" class="form-label">Goal Difference</label>
                                <input type="number" class="form-control" id="goal_difference" name="goal_difference" placeholder="Auto-calculated">
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="goals_for" class="form-label">Goals For *</label>
                                <input type="number" class="form-control" id="goals_for" name="goals_for" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="goals_against" class="form-label">Goals Against *</label>
                                <input type="number" class="form-control" id="goals_against" name="goals_against" min="0" required>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label for="form" class="form-label">Recent Form</label>
                            <input type="text" class="form-control" id="form" name="form" placeholder="e.g., WWLDW" maxlength="10">
                            <small class="text-muted">Use W (Win), L (Loss), D (Draw) - most recent first</small>
                        </div>

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" name="add" class="btn btn-primary" id="submit-button">
                                <i class="ph ph-floppy-disk"></i> Add Standing
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="ph ph-x"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ph ph-list-dashes me-2"></i>Current Standings
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportStandings()">
                            <i class="ph ph-download"></i> Export
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="refreshStandings()">
                            <i class="ph ph-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="standings-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">#</th>
                                    <th>Team</th>
                                    <th class="text-center" style="width: 60px;">GP</th>
                                    <th class="text-center" style="width: 60px;">W</th>
                                    <th class="text-center" style="width: 60px;">D</th>
                                    <th class="text-center" style="width: 60px;">L</th>
                                    <th class="text-center" style="width: 70px;">PTS</th>
                                    <th class="text-center" style="width: 60px;">GF</th>
                                    <th class="text-center" style="width: 60px;">GA</th>
                                    <th class="text-center" style="width: 60px;">GD</th>
                                    <th class="text-center" style="width: 80px;">Form</th>
                                    <th class="text-center" style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for standing in standings %}
                                <tr {% if loop.index <= 3 %}class="table-success"{% endif %}>
                                    <td class="text-center">
                                        {% if loop.index <= 3 %}
                                            <span class="badge bg-success">{{ standing[1] }}</span>
                                        {% else %}
                                            <strong>{{ standing[1] }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ standing[2] }}</strong>
                                    </td>
                                    <td class="text-center">{{ standing[3] }}</td>
                                    <td class="text-center text-success fw-bold">{{ standing[4] }}</td>
                                    <td class="text-center text-warning">{{ standing[5] }}</td>
                                    <td class="text-center text-danger fw-bold">{{ standing[6] }}</td>
                                    <td class="text-center">
                                        <strong class="text-primary">{{ standing[7] }}</strong>
                                    </td>
                                    <td class="text-center">{{ standing[8] }}</td>
                                    <td class="text-center">{{ standing[9] }}</td>
                                    <td class="text-center">
                                        {% set diff = standing[10] %}
                                        <span class="{% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% else %}text-muted{% endif %}">
                                            {% if diff > 0 %}+{% endif %}{{ diff }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if standing[11] %}
                                            <div class="d-flex justify-content-center gap-1">
                                                {% for result in standing[11] %}
                                                    <span class="badge
                                                        {% if result == 'W' %}bg-success
                                                        {% elif result == 'L' %}bg-danger
                                                        {% elif result == 'D' %}bg-warning
                                                        {% else %}bg-secondary{% endif %}"
                                                          style="width: 18px; height: 18px; line-height: 18px; font-size: 9px;">
                                                        {{ result }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-primary btn-sm"
                                                    onclick="editStanding('{{ standing[0] }}', '{{ standing[1] }}', '{{ standing[12] }}', '{{ standing[3] }}', '{{ standing[4] }}', '{{ standing[5] }}', '{{ standing[6] }}', '{{ standing[7] }}', '{{ standing[8] }}', '{{ standing[9] }}', '{{ standing[10] }}', '{{ standing[11] }}')"
                                                    title="Edit">
                                                <i class="ph ph-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteModal"
                                                    data-id="{{ standing[0] }}"
                                                    data-action="{{ url_for('admin.manage_standings') }}"
                                                    title="Delete">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if not standings %}
                    <div class="text-center py-5">
                        <i class="ph ph-table text-muted" style="font-size: 3rem;"></i>
                        <h6 class="text-muted mt-3">No standings data</h6>
                        <p class="text-muted small">Add team standings manually or use auto-calculation from game results.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" method="POST" action="">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-danger">
                            <i class="ph ph-warning-circle fs-1"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Delete Standing Record?</h6>
                            <p class="mb-0 text-muted">This action cannot be undone. The team's standing data will be permanently removed.</p>
                        </div>
                    </div>
                    <input type="hidden" id="deleteItemId" name="deleteItemId">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="delete" class="btn btn-danger">
                        <i class="ph ph-trash"></i> Delete Standing
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Configure Display Modal -->
<div class="modal fade" id="configureDisplayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="ph ph-gear-six me-2"></i>Configure Standings Display
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="displayConfigForm">
                    <!-- Column Visibility -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="ph ph-eye me-2"></i>Visible Columns
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_position" checked disabled>
                                    <label class="form-check-label" for="col_position">Position</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_team" checked disabled>
                                    <label class="form-check-label" for="col_team">Team Name</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_gp" checked>
                                    <label class="form-check-label" for="col_gp">Games Played</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_w" checked>
                                    <label class="form-check-label" for="col_w">Wins</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_d" checked>
                                    <label class="form-check-label" for="col_d">Draws</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_l" checked>
                                    <label class="form-check-label" for="col_l">Losses</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_pts" checked>
                                    <label class="form-check-label" for="col_pts">Points</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_gf" checked>
                                    <label class="form-check-label" for="col_gf">Goals For</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_ga" checked>
                                    <label class="form-check-label" for="col_ga">Goals Against</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_gd" checked>
                                    <label class="form-check-label" for="col_gd">Goal Difference</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="col_form" checked>
                                    <label class="form-check-label" for="col_form">Recent Form</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Highlighting Zones -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="ph ph-paint-brush me-2"></i>Highlight Zones
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Champions League Positions</label>
                                <input type="number" class="form-control" id="cl_spots" value="4" min="0" max="10">
                                <small class="text-muted">Highlight top N teams (green)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Europa League Positions</label>
                                <input type="number" class="form-control" id="el_spots" value="2" min="0" max="10">
                                <small class="text-muted">Highlight next N teams (blue)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Relegation Positions</label>
                                <input type="number" class="form-control" id="rel_spots" value="3" min="0" max="10">
                                <small class="text-muted">Highlight bottom N teams (red)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Playoff Positions</label>
                                <input type="number" class="form-control" id="playoff_spots" value="0" min="0" max="10">
                                <small class="text-muted">Highlight teams in playoff zone (orange)</small>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Display Options -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="ph ph-sliders me-2"></i>Display Options
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_team_logos" checked>
                                    <label class="form-check-label" for="show_team_logos">Show Team Logos</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="color_code_stats" checked>
                                    <label class="form-check-label" for="color_code_stats">Color-code Statistics</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_position_badges" checked>
                                    <label class="form-check-label" for="show_position_badges">Show Position Badges (Top 3)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="compact_mode">
                                    <label class="form-check-label" for="compact_mode">Compact Mode</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_zone_legend" checked>
                                    <label class="form-check-label" for="show_zone_legend">Show Zone Legend</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto_sort" checked>
                                    <label class="form-check-label" for="auto_sort">Auto-sort by Points</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Points System -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="ph ph-calculator me-2"></i>Points System
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Points per Win</label>
                                <input type="number" class="form-control" id="pts_win" value="3" min="1" max="10">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Points per Draw</label>
                                <input type="number" class="form-control" id="pts_draw" value="1" min="0" max="5">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Points per Loss</label>
                                <input type="number" class="form-control" id="pts_loss" value="0" min="0" max="3">
                            </div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="ph ph-info me-2"></i>
                        <div>
                            <strong>Preview:</strong> Changes will be applied to the standings table. This configuration is saved in your browser.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetDisplayConfig()">
                    <i class="ph ph-arrow-counter-clockwise"></i> Reset to Default
                </button>
                <button type="button" class="btn btn-primary" onclick="saveDisplayConfig()">
                    <i class="ph ph-floppy-disk"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Standings Modal -->
<div class="modal fade" id="importStandingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="ph ph-upload me-2"></i>Import Standings Data
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Import from CSV</h6>
                        <form id="csvImportForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Choose CSV File</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                                <small class="text-muted">CSV should have columns: Team, GP, W, D, L, GF, GA</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="ph ph-upload"></i> Upload CSV
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>Import from Game Results</h6>
                        <p class="text-muted small">Automatically calculate standings from completed game results.</p>
                        <div class="mb-3">
                            <label for="seasonSelect" class="form-label">Season</label>
                            <select class="form-select" id="seasonSelect">
                                <option value="">Current Season</option>
                                <!-- Season options would be populated from backend -->
                            </select>
                        </div>
                        <button type="button" class="btn btn-success" onclick="importFromGames()">
                            <i class="ph ph-calculator"></i> Calculate from Games
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate fields when values change
    setupAutoCalculation();

    // Initialize modals
    initializeModals();

    // Load and apply display configuration
    loadDisplayConfig();
    applyDisplayConfig();
});

function setupAutoCalculation() {
    const wonInput = document.getElementById('won');
    const drawInput = document.getElementById('draw');
    const lostInput = document.getElementById('lost');
    const goalsForInput = document.getElementById('goals_for');
    const goalsAgainstInput = document.getElementById('goals_against');
    const pointsInput = document.getElementById('points');
    const goalDiffInput = document.getElementById('goal_difference');

    // Auto-calculate points and goal difference
    function calculateFields() {
        const wins = parseInt(wonInput.value) || 0;
        const draws = parseInt(drawInput.value) || 0;
        const losses = parseInt(lostInput.value) || 0;
        const goalsFor = parseInt(goalsForInput.value) || 0;
        const goalsAgainst = parseInt(goalsAgainstInput.value) || 0;

        // Calculate points (3 for win, 1 for draw, 0 for loss)
        const points = (wins * 3) + (draws * 1);
        pointsInput.value = points;

        // Calculate goal difference
        const goalDiff = goalsFor - goalsAgainst;
        goalDiffInput.value = goalDiff;

        // Update games played
        const gamesPlayed = wins + draws + losses;
        document.getElementById('played_games').value = gamesPlayed;
    }

    // Add event listeners
    [wonInput, drawInput, lostInput, goalsForInput, goalsAgainstInput].forEach(input => {
        input.addEventListener('input', calculateFields);
    });
}

function editStanding(id, position, team_id, played_games, won, draw, lost, points, goals_for, goals_against, goal_difference, form) {
    document.getElementById('standing_id').value = id;
    document.getElementById('position').value = position;
    document.getElementById('team_id').value = team_id;
    document.getElementById('played_games').value = played_games;
    document.getElementById('won').value = won;
    document.getElementById('draw').value = draw;
    document.getElementById('lost').value = lost;
    document.getElementById('points').value = points;
    document.getElementById('goals_for').value = goals_for;
    document.getElementById('goals_against').value = goals_against;
    document.getElementById('goal_difference').value = goal_difference;
    document.getElementById('form').value = form;

    // Update form UI
    document.getElementById('submit-button').innerHTML = '<i class="ph ph-floppy-disk"></i> Update Standing';
    document.getElementById('form-title').innerHTML = '<i class="ph ph-pencil me-2"></i>Edit Team Standing';

    // Scroll to form
    document.getElementById('standing-form').scrollIntoView({ behavior: 'smooth' });
}

function resetForm() {
    document.getElementById('standing-form').reset();
    document.getElementById('standing_id').value = '';
    document.getElementById('submit-button').innerHTML = '<i class="ph ph-floppy-disk"></i> Add Standing';
    document.getElementById('form-title').innerHTML = '<i class="ph ph-plus-circle me-2"></i>Add Team Standing';
}

function initializeModals() {
    // Delete modal
    const deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const action = button.getAttribute('data-action');
        document.getElementById('deleteItemId').value = id;
        document.getElementById('deleteForm').action = action;
    });
}

function recalculateStandings() {
    if (confirm('This will recalculate all standings based on game results. Continue?')) {
        showLoadingToast('Recalculating standings...');

        fetch('/admin/api/standings/recalculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast('Standings recalculated successfully!');
                setTimeout(() => location.reload(), 1500);
            } else {
                showErrorToast('Error recalculating standings: ' + data.message);
            }
        })
        .catch(error => {
            showErrorToast('Error recalculating standings');
            console.error('Error:', error);
        });
    }
}

function importFromGames() {
    const season = document.getElementById('seasonSelect').value;
    showLoadingToast('Importing from game results...');

    fetch('/admin/api/standings/import-games', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({ season_id: season })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast(`Imported ${data.teams_updated} team standings!`);
            bootstrap.Modal.getInstance(document.getElementById('importStandingsModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast('Error importing: ' + data.message);
        }
    })
    .catch(error => {
        showErrorToast('Error importing from games');
        console.error('Error:', error);
    });
}

function exportStandings() {
    const format = prompt('Export format (csv/excel/pdf):', 'csv');
    if (format && ['csv', 'excel', 'pdf'].includes(format.toLowerCase())) {
        window.open(`/admin/api/standings/export?format=${format}`, '_blank');
    }
}

function refreshStandings() {
    showLoadingToast('Refreshing standings...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Toast notifications
function showSuccessToast(message) {
    showToast(message, 'success');
}

function showErrorToast(message) {
    showToast(message, 'danger');
}

function showLoadingToast(message) {
    showToast(message, 'info');
}

function showToast(message, type) {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    // Create toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    container.appendChild(toast);

    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Display Configuration Functions
function getDefaultDisplayConfig() {
    return {
        columns: {
            position: true,
            team: true,
            gp: true,
            w: true,
            d: true,
            l: true,
            pts: true,
            gf: true,
            ga: true,
            gd: true,
            form: true
        },
        zones: {
            cl_spots: 4,
            el_spots: 2,
            rel_spots: 3,
            playoff_spots: 0
        },
        options: {
            show_team_logos: true,
            color_code_stats: true,
            show_position_badges: true,
            compact_mode: false,
            show_zone_legend: true,
            auto_sort: true
        },
        points: {
            win: 3,
            draw: 1,
            loss: 0
        }
    };
}

function loadDisplayConfig() {
    const saved = localStorage.getItem('standings_display_config');
    const config = saved ? JSON.parse(saved) : getDefaultDisplayConfig();

    // Load column visibility
    Object.keys(config.columns).forEach(col => {
        const checkbox = document.getElementById(`col_${col}`);
        if (checkbox && !checkbox.disabled) {
            checkbox.checked = config.columns[col];
        }
    });

    // Load zones
    Object.keys(config.zones).forEach(zone => {
        const input = document.getElementById(zone);
        if (input) input.value = config.zones[zone];
    });

    // Load options
    Object.keys(config.options).forEach(opt => {
        const checkbox = document.getElementById(opt);
        if (checkbox) checkbox.checked = config.options[opt];
    });

    // Load points
    document.getElementById('pts_win').value = config.points.win;
    document.getElementById('pts_draw').value = config.points.draw;
    document.getElementById('pts_loss').value = config.points.loss;
}

function saveDisplayConfig() {
    const config = {
        columns: {
            position: document.getElementById('col_position').checked,
            team: document.getElementById('col_team').checked,
            gp: document.getElementById('col_gp').checked,
            w: document.getElementById('col_w').checked,
            d: document.getElementById('col_d').checked,
            l: document.getElementById('col_l').checked,
            pts: document.getElementById('col_pts').checked,
            gf: document.getElementById('col_gf').checked,
            ga: document.getElementById('col_ga').checked,
            gd: document.getElementById('col_gd').checked,
            form: document.getElementById('col_form').checked
        },
        zones: {
            cl_spots: parseInt(document.getElementById('cl_spots').value),
            el_spots: parseInt(document.getElementById('el_spots').value),
            rel_spots: parseInt(document.getElementById('rel_spots').value),
            playoff_spots: parseInt(document.getElementById('playoff_spots').value)
        },
        options: {
            show_team_logos: document.getElementById('show_team_logos').checked,
            color_code_stats: document.getElementById('color_code_stats').checked,
            show_position_badges: document.getElementById('show_position_badges').checked,
            compact_mode: document.getElementById('compact_mode').checked,
            show_zone_legend: document.getElementById('show_zone_legend').checked,
            auto_sort: document.getElementById('auto_sort').checked
        },
        points: {
            win: parseInt(document.getElementById('pts_win').value),
            draw: parseInt(document.getElementById('pts_draw').value),
            loss: parseInt(document.getElementById('pts_loss').value)
        }
    };

    localStorage.setItem('standings_display_config', JSON.stringify(config));

    showSuccessToast('Display configuration saved!');
    bootstrap.Modal.getInstance(document.getElementById('configureDisplayModal')).hide();

    // Apply the configuration
    applyDisplayConfig();
}

function resetDisplayConfig() {
    if (confirm('Reset all display settings to default?')) {
        localStorage.removeItem('standings_display_config');
        loadDisplayConfig();
        showSuccessToast('Configuration reset to defaults');
    }
}

function applyDisplayConfig() {
    const saved = localStorage.getItem('standings_display_config');
    if (!saved) return;

    const config = JSON.parse(saved);
    const table = document.getElementById('standings-table');
    if (!table) return;

    // Get column indices (0-based, accounting for position and team being first)
    const columnMap = {
        gp: 2,
        w: 3,
        d: 4,
        l: 5,
        pts: 6,
        gf: 7,
        ga: 8,
        gd: 9,
        form: 10
    };

    // Hide/show columns
    Object.keys(columnMap).forEach(col => {
        const index = columnMap[col];
        const visible = config.columns[col];

        // Hide/show header
        const headers = table.querySelectorAll('thead th');
        if (headers[index]) {
            headers[index].style.display = visible ? '' : 'none';
        }

        // Hide/show cells
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells[index]) {
                cells[index].style.display = visible ? '' : 'none';
            }
        });
    });

    // Apply highlighting zones
    const rows = table.querySelectorAll('tbody tr');
    const totalRows = rows.length;

    rows.forEach((row, index) => {
        // Remove existing zone classes
        row.classList.remove('table-success', 'table-info', 'table-warning', 'table-danger');

        const position = index + 1;

        // Champions League zone (green)
        if (position <= config.zones.cl_spots) {
            row.classList.add('table-success');
        }
        // Europa League zone (blue)
        else if (position <= config.zones.cl_spots + config.zones.el_spots) {
            row.classList.add('table-info');
        }
        // Playoff zone (orange)
        else if (config.zones.playoff_spots > 0 &&
                 position > totalRows - config.zones.rel_spots - config.zones.playoff_spots &&
                 position <= totalRows - config.zones.rel_spots) {
            row.classList.add('table-warning');
        }
        // Relegation zone (red)
        else if (position > totalRows - config.zones.rel_spots) {
            row.classList.add('table-danger');
        }
    });

    // Apply compact mode
    if (config.options.compact_mode) {
        table.classList.add('table-sm');
    } else {
        table.classList.remove('table-sm');
    }

    // Show/hide position badges
    if (!config.options.show_position_badges) {
        const badges = table.querySelectorAll('.badge.bg-success');
        badges.forEach(badge => {
            badge.classList.remove('badge', 'bg-success');
            badge.innerHTML = badge.textContent;
        });
    }

    // Add zone legend if enabled
    if (config.options.show_zone_legend) {
        addZoneLegend(config.zones);
    }
}

function addZoneLegend(zones) {
    // Remove existing legend
    const existingLegend = document.getElementById('zone-legend');
    if (existingLegend) existingLegend.remove();

    // Create legend
    const legend = document.createElement('div');
    legend.id = 'zone-legend';
    legend.className = 'alert alert-light mt-3';
    legend.innerHTML = '<strong>Zone Legend:</strong> ';

    const legendItems = [];

    if (zones.cl_spots > 0) {
        legendItems.push('<span class="badge bg-success me-2">Champions League Qualification</span>');
    }
    if (zones.el_spots > 0) {
        legendItems.push('<span class="badge bg-info me-2">Europa League Qualification</span>');
    }
    if (zones.playoff_spots > 0) {
        legendItems.push('<span class="badge bg-warning text-dark me-2">Playoff Zone</span>');
    }
    if (zones.rel_spots > 0) {
        legendItems.push('<span class="badge bg-danger me-2">Relegation Zone</span>');
    }

    legend.innerHTML += legendItems.join('');

    // Insert after standings table
    const tableCard = document.querySelector('.card-body .table-responsive').closest('.card');
    if (tableCard) {
        tableCard.insertAdjacentElement('afterend', legend);
    }
}
</script>
{% endblock %}
