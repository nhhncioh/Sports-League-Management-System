{% extends "base.html" %}

{% block title %}Live Game Console{% endblock %}

{% block content %}
{% set status_value = game.status.value %}
{% set status_color_map = {
    'scheduled': 'secondary',
    'in_progress': 'success',
    'halftime': 'warning',
    'overtime': 'info',
    'final': 'dark'
} %}
{% set status_badge_color = status_color_map.get(status_value, 'secondary') %}
{% set status_label = status_value.replace('_', ' ').title() %}
{% set home_label = game.home_team.name if game.home_team else 'Home' %}
{% set away_label = game.away_team.name if game.away_team else 'Away' %}

<div class="page-header mb-4" aria-labelledby="liveConsoleHeading">
    <div>
        <h1 class="page-title h2 mb-1" id="liveConsoleHeading">Live Game Console</h1>
        <p class="page-subtitle text-muted mb-0">{{ game.home_team.name if game.home_team else 'TBD' }} vs {{ game.away_team.name if game.away_team else 'TBD' }}</p>
    </div>
    <div class="page-actions">
        <span class="badge bg-{{ status_badge_color }} text-uppercase" id="gameStatusBadge" aria-live="polite">{{ status_label }}</span>
    </div>
</div>

<div class="row g-4">
        <!-- Scoreboard -->
        <div class="col-lg-4">
            <section class="card h-100" role="region" aria-labelledby="scoreboardHeading">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0 d-flex align-items-center gap-2" id="scoreboardHeading">
                        <i class="ph ph-clipboard-text" aria-hidden="true"></i>
                        Scoreboard
                    </h2>
                </div>
                <div class="card-body d-grid gap-3">
                    <div class="row text-center" aria-live="polite" aria-atomic="true">
                        <div class="col-5">
                            <p class="text-muted text-uppercase small mb-1">{{ home_label }}</p>
                            <p class="display-4 fw-bold text-primary mb-0" id="homeScore" aria-label="{{ home_label }} score">{{ game.home_score }}</p>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center" aria-hidden="true">
                            <span class="fs-2">-</span>
                        </div>
                        <div class="col-5">
                            <p class="text-muted text-uppercase small mb-1">{{ away_label }}</p>
                            <p class="display-4 fw-bold text-danger mb-0" id="awayScore" aria-label="{{ away_label }} score">{{ game.away_score }}</p>
                        </div>
                    </div>

                    <form class="d-grid gap-3" aria-labelledby="scoreboardHeading" onsubmit="event.preventDefault(); updateScore();">
                        <div>
                            <label class="form-label" for="inputHomeScore">{{ home_label }} Score</label>
                            <input type="number" class="form-control" id="inputHomeScore" value="{{ game.home_score }}" min="0" inputmode="numeric">
                        </div>
                        <div>
                            <label class="form-label" for="inputAwayScore">{{ away_label }} Score</label>
                            <input type="number" class="form-control" id="inputAwayScore" value="{{ game.away_score }}" min="0" inputmode="numeric">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 d-inline-flex justify-content-center align-items-center gap-2">
                            <i class="ph ph-check-circle" aria-hidden="true"></i>
                            <span>Update Score</span>
                        </button>
                    </form>

                    <hr class="my-2">

                    <div class="d-grid gap-2" role="group" aria-label="Game state controls">
                        {% if game.status.value == 'scheduled' %}
                        <button type="button" class="btn btn-success" onclick="startGame()">
                            <i class="ph ph-play" aria-hidden="true"></i> Start Game
                        </button>
                        {% elif game.status.value == 'in_progress' %}
                        <button type="button" class="btn btn-warning" onclick="setHalftime()">
                            <i class="ph ph-pause" aria-hidden="true"></i> Halftime
                        </button>
                        <button type="button" class="btn btn-info" onclick="startOvertime()">
                            <i class="ph ph-clock-counter-clockwise" aria-hidden="true"></i> Start Overtime
                        </button>
                        <button type="button" class="btn btn-danger" onclick="endGame()">
                            <i class="ph ph-stop" aria-hidden="true"></i> End Game
                        </button>
                        {% elif game.status.value == 'halftime' %}
                        <button type="button" class="btn btn-success" onclick="resumeGame()">
                            <i class="ph ph-play" aria-hidden="true"></i> Resume Game
                        </button>
                        {% elif game.status.value == 'overtime' %}
                        <button type="button" class="btn btn-danger" onclick="endGame()">
                            <i class="ph ph-stop" aria-hidden="true"></i> End Game
                        </button>
                        {% elif game.status.value == 'final' and not game.is_reconciled %}
                        <button type="button" class="btn btn-success" onclick="reconcileGame()">
                            <i class="ph ph-check-circle" aria-hidden="true"></i> Reconcile Game
                        </button>
                        {% endif %}
                    </div>

                    {% if game.went_to_overtime %}
                    <div class="alert alert-info mt-2 d-flex align-items-center gap-2" role="status">
                        <i class="ph ph-info" aria-hidden="true"></i>
                        <span>Overtime ({{ game.overtime_periods }} period{{ 's' if game.overtime_periods > 1 else '' }})</span>
                    </div>
                    {% endif %}

                    {% if game.is_reconciled %}
                    <div class="alert alert-success mt-2 d-flex align-items-center gap-2" role="status">
                        <i class="ph ph-check-circle" aria-hidden="true"></i>
                        <span>Game Reconciled</span>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>

        <!-- Events & Actions -->
        <div class="col-lg-8">
            <ul class="nav nav-tabs mb-3" id="consoleTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="console-tab-events" data-bs-toggle="tab" data-bs-target="#eventsTab" type="button" role="tab" aria-controls="eventsTab" aria-selected="true">Events</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="console-tab-penalties" data-bs-toggle="tab" data-bs-target="#penaltiesTab" type="button" role="tab" aria-controls="penaltiesTab" aria-selected="false">Penalties</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="console-tab-stats" data-bs-toggle="tab" data-bs-target="#statsTab" type="button" role="tab" aria-controls="statsTab" aria-selected="false">Player Stats</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="console-tab-history" data-bs-toggle="tab" data-bs-target="#historyTab" type="button" role="tab" aria-controls="historyTab" aria-selected="false">Score History</button>
                </li>
            </ul>

            <div class="tab-content" id="consoleTabContent">
                <!-- Events Tab -->
                <div class="tab-pane fade show active" id="eventsTab" role="tabpanel" aria-labelledby="console-tab-events" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="h6 mb-0">Game Events</h2>
                                <button class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" onclick="showAddEventModal()">
                                    <i class="ph ph-plus" aria-hidden="true"></i> Add Event
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="eventsContainer" role="log" aria-live="polite" aria-busy="true" aria-label="Game events stream">
                                <p class="text-muted mb-0">Loading events...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Penalties Tab -->
                <div class="tab-pane fade" id="penaltiesTab" role="tabpanel" aria-labelledby="console-tab-penalties" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="h6 mb-0">Penalties</h2>
                                <button class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" onclick="showAddPenaltyModal()">
                                    <i class="ph ph-plus" aria-hidden="true"></i> Add Penalty
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="penaltiesContainer" role="log" aria-live="polite" aria-busy="true" aria-label="Penalty log">
                                <p class="text-muted mb-0">Loading penalties...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Tab -->
                <div class="tab-pane fade" id="statsTab" role="tabpanel" aria-labelledby="console-tab-stats" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="h6 mb-0">Player Statistics</h2>
                                <button class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" onclick="showAddStatModal()">
                                    <i class="ph ph-plus" aria-hidden="true"></i> Add Stat
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="statsContainer" role="region" aria-live="polite" aria-busy="true" aria-label="Player statistics">
                                <p class="text-muted mb-0">Loading stats...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="historyTab" role="tabpanel" aria-labelledby="console-tab-history" tabindex="0">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="h6 mb-0">Score Update History</h2>
                        </div>
                        <div class="card-body">
                            <div id="historyContainer" role="log" aria-live="polite" aria-busy="true" aria-label="Score update history">
                                <p class="text-muted mb-0">Loading history...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5 mb-0" id="addEventModalLabel">Add Game Event</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="mb-3">
                        <label class="form-label" for="eventType">Event Type</label>
                        <select class="form-select" id="eventType" required>
                            <option value="goal">Goal</option>
                            <option value="timeout">Timeout</option>
                            <option value="substitution">Substitution</option>
                            <option value="period_start">Period Start</option>
                            <option value="period_end">Period End</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="eventDescription">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addEvent()">Add Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Penalty Modal -->
<div class="modal fade" id="addPenaltyModal" tabindex="-1" aria-labelledby="addPenaltyModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5 mb-0" id="addPenaltyModalLabel">Add Penalty</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPenaltyForm">
                    <div class="mb-3">
                        <label class="form-label" for="penaltyTeam">Team</label>
                        <select class="form-select" id="penaltyTeam" required>
                            {% if game.home_team %}
                            <option value="{{ game.home_team_id }}">{{ game.home_team.name }}</option>
                            {% endif %}
                            {% if game.away_team %}
                            <option value="{{ game.away_team_id }}">{{ game.away_team.name }}</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="penaltyType">Penalty Type</label>
                        <select class="form-select" id="penaltyType" required>
                            <option value="personal_foul">Personal Foul</option>
                            <option value="technical_foul">Technical Foul</option>
                            <option value="yellow_card">Yellow Card</option>
                            <option value="red_card">Red Card</option>
                            <option value="minor_penalty">Minor Penalty</option>
                            <option value="major_penalty">Major Penalty</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="penaltyDescription">Description</label>
                        <textarea class="form-control" id="penaltyDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addPenalty()">Add Penalty</button>
            </div>
        </div>
    </div>
</div>

<script>
const gameId = '{{ game.id }}';

// Auto-refresh every 10 seconds
setInterval(() => {
    loadEvents();
    loadPenalties();
    loadStats();
}, 10000);

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadEvents();
    loadPenalties();
    loadStats();
    loadHistory();
});

async function updateScore() {
    const homeScore = parseInt(document.getElementById('inputHomeScore').value);
    const awayScore = parseInt(document.getElementById('inputAwayScore').value);

    try {
        const response = await fetch(`/live-scoring/api/games/${gameId}/score`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({home_score: homeScore, away_score: awayScore})
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('homeScore').textContent = data.home_score;
            document.getElementById('awayScore').textContent = data.away_score;
            loadHistory();
        }
    } catch (error) {
        console.error('Error updating score:', error);
    }
}

async function startGame() {
    if (!confirm('Start this game?')) return;
    try {
        await fetch(`/live-scoring/api/games/${gameId}/start`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function setHalftime() {
    try {
        await fetch(`/live-scoring/api/games/${gameId}/halftime`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function resumeGame() {
    try {
        await fetch(`/live-scoring/api/games/${gameId}/resume`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function startOvertime() {
    if (!confirm('Start overtime?')) return;
    try {
        await fetch(`/live-scoring/api/games/${gameId}/overtime`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function endGame() {
    if (!confirm('End this game?')) return;
    try {
        await fetch(`/live-scoring/api/games/${gameId}/end`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function reconcileGame() {
    if (!confirm('Reconcile this game? This confirms the final score.')) return;
    try {
        await fetch(`/live-scoring/api/games/${gameId}/reconcile`, {method: 'POST'});
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadEvents() {
    const container = document.getElementById('eventsContainer');
    if (!container) return;
    container.setAttribute('aria-busy', 'true');

    try {
        const response = await fetch(`/live-scoring/api/games/${gameId}/events`);
        const events = await response.json();

        if (events.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No events yet</p>';
        } else {
            const items = events.map(e => `
                <li class="border-bottom pb-2 mb-2">
                    <strong>${e.event_type.replace('_', ' ').toUpperCase()}</strong>
                    ${e.description ? `<br><small class="text-muted">${e.description}</small>` : ''}
                    <br><small class="text-muted">${new Date(e.created_at).toLocaleString()}</small>
                </li>
            `).join('');
            container.innerHTML = `<ul class="list-unstyled mb-0">${items}</ul>`;
        }
    } catch (error) {
        console.error('Error loading events:', error);
        container.innerHTML = '<p class="text-danger mb-0">Unable to load events.</p>';
    } finally {
        container.setAttribute('aria-busy', 'false');
    }
}

async function loadPenalties() {
    const container = document.getElementById('penaltiesContainer');
    if (!container) return;
    container.setAttribute('aria-busy', 'true');

    try {
        const response = await fetch(`/live-scoring/api/games/${gameId}/penalties`);
        const penalties = await response.json();

        if (penalties.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No penalties yet</p>';
        } else {
            const items = penalties.map(p => `
                <li class="border-bottom pb-2 mb-2">
                    <strong>${p.penalty_type.replace('_', ' ').toUpperCase()}</strong>
                    ${p.player_name ? `<br>${p.player_name}` : ''}
                    ${p.description ? `<br><small class="text-muted">${p.description}</small>` : ''}
                    ${p.resulted_in_ejection ? '<br><span class="badge bg-danger">Ejection</span>' : ''}
                </li>
            `).join('');
            container.innerHTML = `<ul class="list-unstyled mb-0">${items}</ul>`;
        }
    } catch (error) {
        console.error('Error loading penalties:', error);
        container.innerHTML = '<p class="text-danger mb-0">Unable to load penalties.</p>';
    } finally {
        container.setAttribute('aria-busy', 'false');
    }
}

async function loadStats() {
    const container = document.getElementById('statsContainer');
    if (!container) return;
    container.setAttribute('aria-busy', 'true');

    try {
        const response = await fetch(`/live-scoring/api/games/${gameId}/stats`);
        const stats = await response.json();

        if (stats.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No stats yet</p>';
        } else {
            const items = stats.map(s => `
                <li class="border-bottom pb-2 mb-2">
                    <strong>${s.player_name}</strong>: ${s.stat_type.replace('_', ' ')} = ${s.value}
                </li>
            `).join('');
            container.innerHTML = `<ul class="list-unstyled mb-0">${items}</ul>`;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
        container.innerHTML = '<p class="text-danger mb-0">Unable to load stats.</p>';
    } finally {
        container.setAttribute('aria-busy', 'false');
    }
}

async function loadHistory() {
    const container = document.getElementById('historyContainer');
    if (!container) return;
    container.setAttribute('aria-busy', 'true');

    try {
        const response = await fetch(`/live-scoring/api/games/${gameId}/score-history`);
        const history = await response.json();

        if (history.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No score updates yet</p>';
        } else {
            const items = history.map(h => `
                <li class="border-bottom pb-2 mb-2">
                    <span class="d-block">
                        <span class="fw-semibold">${h.previous_home_score}-${h.previous_away_score}</span>
                        &rarr;
                        <span class="fw-semibold">${h.new_home_score}-${h.new_away_score}</span>
                    </span>
                    <span class="badge bg-secondary">${h.update_type.replace('_', ' ')}</span>
                    <br><small class="text-muted">${new Date(h.created_at).toLocaleString()}</small>
                </li>
            `).join('');
            container.innerHTML = `<ul class="list-unstyled mb-0">${items}</ul>`;
        }
    } catch (error) {
        console.error('Error loading history:', error);
        container.innerHTML = '<p class="text-danger mb-0">Unable to load history.</p>';
    } finally {
        container.setAttribute('aria-busy', 'false');
    }
}

function showAddEventModal() {
    const modalEl = document.getElementById('addEventModal');
    const previouslyFocused = document.activeElement;
    modalEl.addEventListener('shown.bs.modal', () => document.getElementById('eventType').focus(), { once: true });
    if (previouslyFocused) {
        modalEl.addEventListener('hidden.bs.modal', () => previouslyFocused.focus(), { once: true });
    }
    const modalInstance = new bootstrap.Modal(modalEl);
    modalInstance.show();
}

function showAddPenaltyModal() {
    const modalEl = document.getElementById('addPenaltyModal');
    const previouslyFocused = document.activeElement;
    modalEl.addEventListener('shown.bs.modal', () => document.getElementById('penaltyTeam').focus(), { once: true });
    if (previouslyFocused) {
        modalEl.addEventListener('hidden.bs.modal', () => previouslyFocused.focus(), { once: true });
    }
    const modalInstance = new bootstrap.Modal(modalEl);
    modalInstance.show();
}

async function addEvent() {
    const data = {
        event_type: document.getElementById('eventType').value,
        description: document.getElementById('eventDescription').value
    };

    try {
        await fetch(`/live-scoring/api/games/${gameId}/events`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
        loadEvents();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function addPenalty() {
    const data = {
        team_id: document.getElementById('penaltyTeam').value,
        penalty_type: document.getElementById('penaltyType').value,
        description: document.getElementById('penaltyDescription').value
    };

    try {
        await fetch(`/live-scoring/api/games/${gameId}/penalties`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        bootstrap.Modal.getInstance(document.getElementById('addPenaltyModal')).hide();
        loadPenalties();
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
{% endblock %}

