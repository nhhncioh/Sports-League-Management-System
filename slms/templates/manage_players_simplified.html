{% extends "base.html" %}
{% block title %}Player Management - CRM{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Admin</a></li>
                    <li class="breadcrumb-item active">Player Management</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Player Management CRM</h1>
                    <p class="text-muted">Comprehensive player database and relationship management</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                        <i class="ph ph-plus"></i> Add Player
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Dashboard -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-primary">
                        <i class="ph ph-users"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="text-primary mb-0">{{ players|length }}</h3>
                        <small class="text-muted">Total Players</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-success">
                        <i class="ph ph-check-circle"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="text-success mb-0">{{ players|length }}</h3>
                        <small class="text-muted">Active Players</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-warning">
                        <i class="ph ph-users-three"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="text-warning mb-0">{{ teams|length }}</h3>
                        <small class="text-muted">Teams</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-info">
                        <i class="ph ph-globe"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="text-info mb-0">{{ players|map(attribute=5)|unique|list|length }}</h3>
                        <small class="text-muted">Nationalities</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Players Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ph ph-table"></i> Players Database
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Player</th>
                                    <th>Team</th>
                                    <th>Position</th>
                                    <th>Age</th>
                                    <th>Nationality</th>
                                    <th>Status</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in players %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-placeholder me-3">
                                                <i class="ph ph-user"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ player[2] }}</h6>
                                                <small class="text-muted">{{ player[5] }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="team-badge">{{ player[1] }}</span>
                                    </td>
                                    <td>
                                        <span class="position-pill position-{{ player[3].lower() }}">
                                            {{ player[3] }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if player[4] %}
                                            Born {{ player[4][:4] }}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </td>
                                    <td>{{ player[5] }}</td>
                                    <td>
                                        <span class="badge status-badge status-active">
                                            Active
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary"
                                                    onclick="editPlayer('{{ player[0] }}', '{{ player[6] }}', '{{ player[2] }}', '{{ player[3] }}', '{{ player[4] }}', '{{ player[5] }}')"
                                                    title="Edit">
                                                <i class="ph ph-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteModal"
                                                    data-id="{{ player[0] }}"
                                                    title="Delete">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not players %}
                    <div class="p-5 text-center text-muted">
                        <i class="ph ph-users" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No players found</h5>
                        <p>Start by adding your first player.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                            <i class="ph ph-plus"></i> Add Player
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('admin.manage_players') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlayerModalLabel">Add New Player</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="player_id" name="player_id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Player Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required placeholder="Full name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="team_id" class="form-label">Team *</label>
                                <select class="form-select" id="team_id" name="team_id" required>
                                    <option value="">Select Team</option>
                                    {% for team in teams %}
                                    <option value="{{ team[0] }}">{{ team[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="position" class="form-label">Position *</label>
                                <select class="form-select" id="position" name="position" required>
                                    <option value="">Select Position</option>
                                    <option value="Goalkeeper">Goalkeeper</option>
                                    <option value="Defender">Defender</option>
                                    <option value="Midfielder">Midfielder</option>
                                    <option value="Forward">Forward</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_of_birth" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nationality" class="form-label">Nationality *</label>
                                <input type="text" class="form-control" id="nationality" name="nationality" required placeholder="e.g., American, British">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Additional Fields</label>
                                <div class="alert alert-info">
                                    <small>More fields will be available when the database is extended.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="submit" class="btn btn-primary" id="submitPlayerBtn">
                        <i class="ph ph-plus"></i> Add Player
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" method="POST" action="{{ url_for('admin.manage_players') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="ph ph-warning"></i>
                        Are you sure you want to delete this player? This action cannot be undone.
                    </div>
                    <input type="hidden" id="deleteItemId" name="deleteEntityId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="delete" class="btn btn-danger">
                        <i class="ph ph-trash"></i> Delete Player
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Edit player function
    function editPlayer(id, team_id, name, position, date_of_birth, nationality) {
        document.getElementById('player_id').value = id;
        document.getElementById('team_id').value = team_id;
        document.getElementById('name').value = name;
        document.getElementById('position').value = position;
        document.getElementById('date_of_birth').value = date_of_birth;
        document.getElementById('nationality').value = nationality;

        document.getElementById('submitPlayerBtn').innerHTML = '<i class="ph ph-check"></i> Update Player';
        document.getElementById('addPlayerModalLabel').textContent = 'Edit Player';

        const modal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
        modal.show();
    }

    // Delete modal handler
    document.getElementById('deleteModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        document.getElementById('deleteItemId').value = id;
    });

    // Reset modal when opening for new player
    document.getElementById('addPlayerModal').addEventListener('show.bs.modal', function(event) {
        if (!event.relatedTarget || !event.relatedTarget.onclick) {
            // Reset form for new player
            document.getElementById('player_id').value = '';
            document.getElementById('addPlayerModalLabel').textContent = 'Add New Player';
            document.getElementById('submitPlayerBtn').innerHTML = '<i class="ph ph-plus"></i> Add Player';
            this.querySelector('form').reset();
        }
    });
</script>
{% endblock %}