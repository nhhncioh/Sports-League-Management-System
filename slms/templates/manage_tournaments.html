{% extends "base.html" %}
{% block title %}Manage Tournaments{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Manage Tournaments</h1>
  <div class="row">
    <div class="col-md-5">
      <h4>Create / Edit</h4>
      <form method="POST" action="{{ url_for('admin.manage_tournaments') }}">
        <input type="hidden" id="tournament_id" name="tournament_id">
        <input type="hidden" name="action" id="action" value="add">
        <div class="form-group">
          <label for="name">Name</label>
          <input class="form-control" type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
          <label for="league_id">League (optional)</label>
          <select class="form-control" id="league_id" name="league_id">
            <option value="">None</option>
            {% for l in leagues %}
              <option value="{{ l[0] }}">{{ l[1] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="season_id">Season (optional)</label>
          <select class="form-control" id="season_id" name="season_id">
            <option value="">None</option>
            {% for s in seasons %}
              <option value="{{ s[0] }}">{{ s[1] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="tournament_type">Type</label>
            <select class="form-control" id="tournament_type" name="tournament_type">
              <option value="round-robin">Round-robin</option>
              <option value="knockout">Knockout</option>
              <option value="group-stage">Group stage</option>
            </select>
          </div>
          <div class="form-group col-md-6">
            <label for="status">Status</label>
            <select class="form-control" id="status" name="status">
              <option value="planned">Planned</option>
              <option value="ongoing">Ongoing</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="start_date">Start Date</label>
            <input class="form-control" type="date" id="start_date" name="start_date">
          </div>
          <div class="form-group col-md-6">
            <label for="end_date">End Date</label>
            <input class="form-control" type="date" id="end_date" name="end_date">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
      </form>
    </div>
    <div class="col-md-7">
      <h4>Existing Tournaments</h4>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Name</th>
            <th>League</th>
            <th>Season</th>
            <th>Type</th>
            <th>Status</th>
            <th>Dates</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tournaments %}
          <tr>
            <td>{{ t[1] }}</td>
            <td>{{ (leagues | selectattr(0, 'equalto', t[2]) | map(attribute=1) | list)[0] if t[2] else '-' }}</td>
            <td>
              {% set s = seasons | selectattr(0, 'equalto', t[3]) | map(attribute=1) | list %}
              {{ s[0] if s|length > 0 else '-' }}
            </td>
            <td>{{ t[4] }}</td>
            <td>{{ t[7] }}</td>
            <td>
              {% if t[5] %}{{ t[5] }}{% else %}-{% endif %} â†’ {% if t[6] %}{{ t[6] }}{% else %}-{% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-success" onclick="editTournament({
                id: '{{ t[0] }}',
                name: '{{ t[1] | replace("'","\'") }}',
                league_id: '{{ t[2] or '' }}',
                season_id: '{{ t[3] or '' }}',
                tournament_type: '{{ t[4] or '' }}',
                start_date: '{{ t[5] or '' }}',
                end_date: '{{ t[6] or '' }}',
                status: '{{ t[7] or '' }}'
              })">Edit</button>
              <form class="d-inline" method="POST" action="{{ url_for('admin.manage_tournaments') }}" onsubmit="return confirm('Delete this tournament?');">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="deleteEntityId" value="{{ t[0] }}">
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  function editTournament(t) {
    document.getElementById('action').value = 'edit';
    document.getElementById('tournament_id').value = t.id || '';
    document.getElementById('name').value = t.name || '';
    document.getElementById('league_id').value = t.league_id || '';
    document.getElementById('season_id').value = t.season_id || '';
    document.getElementById('tournament_type').value = t.tournament_type || 'round-robin';
    document.getElementById('status').value = t.status || 'planned';
    document.getElementById('start_date').value = t.start_date || '';
    document.getElementById('end_date').value = t.end_date || '';
  }
  function resetForm(){
    document.getElementById('action').value = 'add';
    document.getElementById('tournament_id').value = '';
    document.getElementById('name').value = '';
    document.getElementById('league_id').value = '';
    document.getElementById('season_id').value = '';
    document.getElementById('tournament_type').value = 'round-robin';
    document.getElementById('status').value = 'planned';
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
  }
</script>
{% endblock %}

