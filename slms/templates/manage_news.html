{% extends "base.html" %}

{% block title %}Manage News - Admin{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">News Management</h1>
            <p class="text-muted">Create and manage league news articles</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewsModal">
            <i class="ph ph-plus me-2"></i>Add News Article
        </button>
    </div>

    <!-- News Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                <i class="ph ph-newspaper text-primary fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="card-title text-muted mb-1">Total Articles</h6>
                            <h3 class="mb-0">{{ news_articles|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                <i class="ph ph-check-circle text-success fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="card-title text-muted mb-1">Published</h6>
                            <h3 class="mb-0">{{ news_articles|selectattr('5', 'equalto', 'published')|list|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                                <i class="ph ph-clock text-warning fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="card-title text-muted mb-1">Draft</h6>
                            <h3 class="mb-0">{{ news_articles|selectattr('5', 'equalto', 'draft')|list|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                <i class="ph ph-house text-info fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="card-title text-muted mb-1">On Homepage</h6>
                            <h3 class="mb-0">{{ news_articles|selectattr('7', 'equalto', true)|list|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Articles Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">News Articles</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                    </select>
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="General">General</option>
                        <option value="Announcements">Announcements</option>
                        <option value="Registration">Registration</option>
                        <option value="Events">Events</option>
                        <option value="Results">Results</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Featured</th>
                            <th>Homepage</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for article in news_articles %}
                        <tr data-status="{{ article[5] }}" data-category="{{ article[4] }}">
                            <td>
                                <div>
                                    <h6 class="mb-1">{{ article[1] }}</h6>
                                    <small class="text-muted">{{ article[2][:100] }}{% if article[2]|length > 100 %}...{% endif %}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ article[4] }}</span>
                            </td>
                            <td>
                                {% if article[5] == 'published' %}
                                    <span class="badge bg-success">Published</span>
                                {% else %}
                                    <span class="badge bg-warning">Draft</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if article[6] %}
                                    <i class="ph ph-star-fill text-warning"></i>
                                {% else %}
                                    <i class="ph ph-star text-muted"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if article[7] %}
                                    <i class="ph ph-check-circle-fill text-success"></i>
                                {% else %}
                                    <i class="ph ph-x-circle text-muted"></i>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ article[8].strftime('%b %d, %Y') if article[8] else 'N/A' }}</small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="editNews('{{ article[0] }}', '{{ article[1] }}', '{{ article[2] }}', '{{ article[3] }}', '{{ article[4] }}', '{{ article[5] }}', {{ article[6]|lower }}, {{ article[7]|lower }})">
                                        <i class="ph ph-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal" data-bs-target="#deleteModal"
                                            data-id="{{ article[0] }}" data-name="{{ article[1] }}">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit News Modal -->
<div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form action="{{ url_for('admin.manage_news') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNewsModalLabel">Add News Article</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="news_id" name="news_id">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">Article Title *</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="General">General</option>
                                    <option value="Announcements">Announcements</option>
                                    <option value="Registration">Registration</option>
                                    <option value="Events">Events</option>
                                    <option value="Results">Results</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="summary" class="form-label">Summary</label>
                        <textarea class="form-control" id="summary" name="summary" rows="2" placeholder="Brief summary for previews and social sharing"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">Article Content *</label>
                        <textarea class="form-control" id="content" name="content" rows="10" required placeholder="Write your article content here..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="image_url" class="form-label">Featured Image URL</label>
                                <input type="url" class="form-control" id="image_url" name="image_url" placeholder="https://example.com/image.jpg">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="draft">Draft</option>
                                    <option value="published">Published</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured">
                                <label class="form-check-label" for="is_featured">
                                    <i class="ph ph-star me-1"></i>Featured Article
                                </label>
                                <small class="form-text text-muted d-block">Featured articles appear prominently</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="show_on_homepage" name="show_on_homepage">
                                <label class="form-check-label" for="show_on_homepage">
                                    <i class="ph ph-house me-1"></i>Show on Homepage
                                </label>
                                <small class="form-text text-muted d-block">Display this article on the league homepage</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="submit" class="btn btn-primary" id="submitNewsBtn">
                        <i class="ph ph-plus me-2"></i>Create Article
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.manage_news') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="ph ph-warning me-2"></i>
                        Are you sure you want to delete this news article? This action cannot be undone.
                    </div>
                    <input type="hidden" id="deleteEntityId" name="deleteEntityId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="delete" class="btn btn-danger">
                        <i class="ph ph-trash me-2"></i>Delete Article
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Filter functionality
document.getElementById('statusFilter').addEventListener('change', filterTable);
document.getElementById('categoryFilter').addEventListener('change', filterTable);

function filterTable() {
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const category = row.getAttribute('data-category');

        const statusMatch = !statusFilter || status === statusFilter;
        const categoryMatch = !categoryFilter || category === categoryFilter;

        if (statusMatch && categoryMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Edit news functionality
function editNews(newsId, title, summary, content, category, status, isFeatured, showOnHomepage) {
    document.getElementById('news_id').value = newsId;
    document.getElementById('title').value = title;
    document.getElementById('summary').value = summary;
    document.getElementById('content').value = content;
    document.getElementById('category').value = category;
    document.getElementById('status').value = status;
    document.getElementById('is_featured').checked = isFeatured;
    document.getElementById('show_on_homepage').checked = showOnHomepage;

    document.getElementById('addNewsModalLabel').textContent = 'Edit News Article';
    document.getElementById('submitNewsBtn').innerHTML = '<i class="ph ph-check me-2"></i>Update Article';

    const modal = new bootstrap.Modal(document.getElementById('addNewsModal'));
    modal.show();
}

// Reset modal when opening for new article
document.getElementById('addNewsModal').addEventListener('show.bs.modal', function(event) {
    if (!event.relatedTarget || !event.relatedTarget.onclick) {
        // Reset form for new article
        document.getElementById('news_id').value = '';
        document.getElementById('addNewsModalLabel').textContent = 'Add News Article';
        document.getElementById('submitNewsBtn').innerHTML = '<i class="ph ph-plus me-2"></i>Create Article';
        this.querySelector('form').reset();
    }
});

// Delete modal functionality
document.getElementById('deleteModal').addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const newsId = button.getAttribute('data-id');
    const newsTitle = button.getAttribute('data-name');

    document.getElementById('deleteEntityId').value = newsId;
    document.querySelector('#deleteModal .modal-body .alert').innerHTML =
        '<i class="ph ph-warning me-2"></i>Are you sure you want to delete "' + newsTitle + '"? This action cannot be undone.';
});
</script>
{% endblock %}