{% extends "base.html" %}
{% block title %}Player Stats - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.leaderboard-page .stat-card{border:none;border-radius:1rem;box-shadow:0 10px 30px rgba(15,23,42,0.08);} 
.leaderboard-page .stat-label{font-size:0.85rem;text-transform:uppercase;letter-spacing:0.06em;}
.leaderboard-card{border:none;border-radius:1rem;box-shadow:0 18px 44px rgba(15,23,42,0.08);} 
.leaderboard-card .card-header{border-bottom:1px solid rgba(15,23,42,0.05);} 
.leaderboard-table th{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#6b7280;border-top:none;border-bottom:1px solid rgba(148,163,184,0.35);}
.sortable-header{cursor:pointer;user-select:none;transition:background-color 0.2s ease;}
.sortable-header:hover{background-color:rgba(37,99,235,0.08);}
.sort-icon{margin-left:0.25rem;opacity:0.6;transition:opacity 0.2s ease;}
.sortable-header:hover .sort-icon{opacity:1;}
.sort-asc .sort-icon::before{content:'↑';}
.sort-desc .sort-icon::before{content:'↓';}
.sort-icon::before{content:'↕';} 
.leaderboard-table td{vertical-align:middle;border-bottom:1px solid rgba(148,163,184,0.15);} 
.rank-pill{display:inline-flex;align-items:center;justify-content:center;width:2.5rem;height:2.5rem;border-radius:0.85rem;font-weight:600;background:linear-gradient(135deg,var(--slms-gradient-start,#2563eb),var(--slms-gradient-end,#1d4ed8));color:#fff;} 
.momentum-meter{height:0.5rem;border-radius:999px;background-color:rgba(148,163,184,0.25);overflow:hidden;} 
.momentum-meter .fill{height:100%;background:linear-gradient(90deg,#22c55e,#0ea5e9);} 
.metric-badge{display:inline-flex;align-items:center;gap:0.35rem;padding:0.35rem 0.65rem;border-radius:999px;font-size:0.75rem;background-color:rgba(37,99,235,0.08);color:#1e3a8a;} 
.metric-badge .label{font-weight:600;text-transform:uppercase;letter-spacing:0.05em;} 
.metric-badge .value{font-weight:600;} 
.leaderboard-actions .btn{border-radius:0.65rem;} 
.analytics-card{border:none;border-radius:1rem;box-shadow:0 14px 32px rgba(15,23,42,0.08);position:relative;overflow:hidden;} 
.analytics-card .accent{position:absolute;inset:0;opacity:0.08;pointer-events:none;background:linear-gradient(135deg,var(--slms-gradient-start,#2563eb),var(--slms-gradient-end,#1d4ed8));} 
.analytics-card .card-body{position:relative;} 
.custom-metric-table th,.custom-metric-table td{padding:0.75rem;} 
.search-group .form-control{min-width:240px;} 
@media(max-width:992px){.leaderboard-page .search-group .form-control{min-width:unset;width:220px;}}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 leaderboard-page">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Player Stats</h1>
            <p class="text-muted mb-0">Compare top performers, reveal momentum, and manage advanced analytics across every competition.</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="input-group search-group shadow-sm">
                <span class="input-group-text bg-white border-end-0"><i class="ph ph-magnifying-glass"></i></span>
                <input type="search" class="form-control border-start-0" id="leaderboardSearch" placeholder="Search player, league, or season">
            </div>
            <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#leaderboardFilters" type="button">
                <i class="ph ph-funnel me-2"></i>Filters
            </button>
            <button class="btn btn-primary" type="button" onclick="openBasicModal()">
                <i class="ph ph-plus me-2"></i>Add Player Stats
            </button>
        </div>
    </div>

    <div class="collapse mb-4" id="leaderboardFilters">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterSeason">Season</label>
                        <select class="form-select" id="filterSeason">
                            <option value="">All Seasons</option>
                            {% for season in seasons %}
                                <option value="{{ season[0] }}">{{ season[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterLeague">League</label>
                        <select class="form-select" id="filterLeague">
                            <option value="">All Leagues</option>
                            {% for league in leagues %}
                                <option value="{{ league.id }}" data-sport="{{ league.sport }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterRating">Minimum Rating</label>
                        <select class="form-select" id="filterRating">
                            <option value="">All Ratings</option>
                            <option value="70">70+</option>
                            <option value="75">75+</option>
                            <option value="80">80+</option>
                            <option value="85">85+</option>
                        </select>
                    </div>
                    <div class="col-md-12 mt-3">
                        <div class="alert alert-info d-none" id="sportIndicator">
                            <i class="ph ph-info me-2"></i>
                            <strong>Sport:</strong> <span id="sportName"></span> |
                            <strong>Primary Stats:</strong> <span id="sportPrimaryStats"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Active players</div>
                <div class="d-flex align-items-baseline gap-2">
                    <span class="fs-3 fw-bold">{{ analytics_summary.total_players }}</span>
                    <span class="text-success small fw-semibold">Leaderboard depth</span>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Total goals</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.total_goals }}</div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Goal contributions</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.total_goals + analytics_summary.total_assists }}</div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Average rating</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.avg_rating or '?' }}</div>
            </div>
        </div>
    </div>

    <div class="card leaderboard-card mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div>
                    <h2 class="h5 mb-0">Player Statistics</h2>
                    <small class="text-muted">Click column headers to sort by that statistic.</small>
                </div>
                <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">{{ leaderboard|length }} entries</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table leaderboard-table align-middle mb-0" id="leaderboardTable">
                <thead>
                    <tr>
                        <th scope="col">Rank</th>
                        <th scope="col" class="sortable-header" data-sort="player">Player<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="league">League / Season<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="goals">Goals<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="assists">Assists<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="contributions">G + A<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="per-match">Per Match<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="per-90">Per 90<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="shot-accuracy">Shot %<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="pass-accuracy">Pass %<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="rating">Rating<span class="sort-icon"></span></th>
                        <th scope="col" class="sortable-header" data-sort="momentum" style="width:160px;">Momentum<span class="sort-icon"></span></th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in leaderboard %}
                    <tr data-player="{{ entry.player_name|lower }}"
                        data-league="{{ entry.league_id }}"
                        data-season="{{ entry.season_id }}"
                        data-rating="{{ entry.rating or '' }}"
                        data-goals="{{ entry.goals }}"
                        data-assists="{{ entry.assists }}"
                        data-contributions="{{ entry.goal_contributions }}"
                        data-per-match="{{ entry.per_game_contribution or 0 }}"
                        data-per-90="{{ entry.per_90_contribution or 0 }}"
                        data-shot-accuracy="{{ entry.shot_accuracy or 0 }}"
                        data-pass-accuracy="{{ entry.pass_accuracy or 0 }}"
                        data-momentum="{{ entry.momentum or 0 }}"
                        data-player-name="{{ entry.player_name }}"
                        data-league-name="{{ entry.league_name }}"
                        data-season-year="{{ entry.season_year }}">
                        <td>
                            <div class="rank-pill{% if entry.rank == 1 %} shadow{% endif %}">{{ entry.rank }}</div>
                        </td>
                        <td>
                            <div class="fw-semibold text-dark">{{ entry.player_name }}</div>
                            <div class="text-muted small">{{ entry.games_played }} games ? {{ entry.minutes_played }} mins</div>
                            {% if entry.custom_metrics %}
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    {% for label, value in entry.custom_metrics.items() %}
                                        <span class="badge rounded-pill bg-light text-secondary border">{{ label }}: {{ value }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-semibold">{{ entry.league_name }}</div>
                            <div class="text-muted small">{{ entry.season_year }}</div>
                        </td>
                        <td class="fw-bold text-primary">{{ entry.goals }}</td>
                        <td class="fw-bold text-success">{{ entry.assists }}</td>
                        <td class="fw-bold">{{ entry.goal_contributions }}</td>
                        <td>{{ entry.per_game_contribution|round(2) if entry.per_game_contribution is not none else '?' }}</td>
                        <td>{{ entry.per_90_contribution|round(2) if entry.per_90_contribution is not none else '?' }}</td>
                        <td>{{ (entry.shot_accuracy * 100)|round(1) if entry.shot_accuracy is not none else '?' }}{% if entry.shot_accuracy is not none %}%{% endif %}</td>
                        <td>{{ (entry.pass_accuracy * 100)|round(1) if entry.pass_accuracy is not none else '?' }}{% if entry.pass_accuracy is not none %}%{% endif %}</td>
                        <td>{{ entry.rating|round(1) if entry.rating is not none else '?' }}</td>
                        <td>
                            <div class="momentum-meter">
                                <div class="fill" style="width: {{ entry.momentum }}%;"></div>
                            </div>
                            <small class="text-muted d-block mt-1">{{ entry.analytics_score|round(1) }}</small>
                        </td>
                        <td class="text-end leaderboard-actions">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="openBasicModal({{ entry.scorer_id }})">
                                    <i class="ph ph-pencil-simple"></i> Edit
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ entry.scorer_id }}, {{ entry.player_name|tojson }})">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="13" class="py-5 text-center text-muted">No scorer data available yet. Add player statistics to populate the leaderboard.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Top Scorer</div>
                    {% if analytics_summary.top_goal_scorer %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.top_goal_scorer.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.top_goal_scorer.goals }} goals ? {{ analytics_summary.top_goal_scorer.assists }} assists</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Assist Leader</div>
                    {% if analytics_summary.top_assist_player %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.top_assist_player.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.top_assist_player.assists }} assists</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Efficiency</div>
                    {% if analytics_summary.most_efficient %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.most_efficient.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.most_efficient.per_game_contribution|round(2) }} contributions / match</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Highest Rating</div>
                    {% if analytics_summary.best_rating %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.best_rating.player_name }}</h5>
                        <div class="text-muted small">Rating {{ analytics_summary.best_rating.rating|round(1) }}</div>
                    {% else %}
                        <div class="text-muted">No rating data</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if custom_metric_summary %}
    <div class="card shadow-sm rounded-4 mt-4">
        <div class="card-header bg-white py-3">
            <h2 class="h6 mb-0">Custom Metric Spotlight</h2>
        </div>
        <div class="table-responsive">
            <table class="table custom-metric-table mb-0">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Average</th>
                        <th>Peak Value</th>
                        <th>Leaderboard</th>
                    </tr>
                </thead>
                <tbody>
                    {% for metric, snapshot in custom_metric_summary.items() %}
                        <tr>
                            <td class="fw-semibold">{{ metric }}</td>
                            <td>{{ snapshot.average }}</td>
                            <td>{{ snapshot.max }}</td>
                            <td>{{ snapshot.leader }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Combined Player Stats Modal -->
<div class="modal fade" id="basicStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <form class="modal-content" method="post" id="combinedStatsForm">
            <input type="hidden" name="scorer_id" id="basicScorerId">
            <input type="hidden" name="custom_metrics_json" id="combinedCustomMetrics">
            <div class="modal-header">
                <h5 class="modal-title" id="basicModalTitle">Add Player Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Basic Info Section -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label" for="basicPlayer">Player</label>
                        <select class="form-select" name="player_id" id="basicPlayer" required>
                            <option value="">Select player</option>
                            {% for player in players %}
                                <option value="{{ player[0] }}">{{ player[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicSeason">Season</label>
                        <select class="form-select" name="season_id" id="basicSeason" required>
                            <option value="">Select season</option>
                            {% for season in seasons %}
                                <option value="{{ season[0] }}">{{ season[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicLeague">League</label>
                        <select class="form-select" name="league_id" id="basicLeague" required onchange="onLeagueChange()">
                            <option value="">Select league</option>
                            {% for league in leagues %}
                                <option value="{{ league.id }}" data-sport="{{ league.sport }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Sport Info Banner -->
                <div class="alert alert-info d-none mb-4" id="basicSportHelp">
                    <div class="d-flex align-items-start gap-2">
                        <i class="ph ph-info fs-5"></i>
                        <div>
                            <strong><span id="basicSportName"></span> Statistics</strong>
                            <p class="mb-0 small">Enter statistics for this player. All fields are optional except the basic stats.</p>
                        </div>
                    </div>
                </div>

                <!-- Basic Stats (Required) -->
                <h6 class="mb-3"><i class="ph ph-chart-bar me-2"></i>Basic Statistics</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label" for="basicGoals"><span id="basicGoalsLabel">Goals</span></label>
                        <input type="number" class="form-control" name="goals" id="basicGoals" min="0" value="0" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicAssists">Assists</label>
                        <input type="number" class="form-control" name="assists" id="basicAssists" min="0" value="0" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicPenalties">Penalties</label>
                        <input type="number" class="form-control" name="penalties" id="basicPenalties" min="0" value="0" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="combinedRating">Performance rating</label>
                        <input type="number" step="0.1" class="form-control" id="combinedRating" name="rating" min="0" max="10" placeholder="0-10">
                    </div>
                </div>

                <!-- Playing Time -->
                <h6 class="mb-3"><i class="ph ph-clock me-2"></i>Playing Time</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label" for="combinedGames">Games played</label>
                        <input type="number" class="form-control" id="combinedGames" name="games_played" min="0" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="combinedMinutes">Minutes played</label>
                        <input type="number" class="form-control" id="combinedMinutes" name="minutes_played" min="0" value="0">
                    </div>
                </div>

                <!-- Sport-Specific Stats (Dynamically generated based on league) -->
                <div id="sportSpecificSection" class="d-none">
                    <h6 class="mb-3"><i class="ph ph-trophy me-2"></i>Sport-Specific Statistics</h6>
                    <div id="sportSpecificStatsContainer" class="row g-3 mb-4">
                        <!-- Will be populated by JavaScript based on sport -->
                    </div>
                </div>

                <!-- Legacy Stats (Keep for backward compatibility) -->
                <div class="collapse" id="legacyStatsSection">
                    <h6 class="mb-3"><i class="ph ph-archive me-2"></i>Additional Stats</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label" for="combinedShotsOnTarget">Shots on target</label>
                            <input type="number" class="form-control" id="combinedShotsOnTarget" name="shots_on_target" min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="combinedShotAttempts">Total shot attempts</label>
                            <input type="number" class="form-control" id="combinedShotAttempts" name="shot_attempts" min="0" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="combinedSaves">Saves / blocks</label>
                            <input type="number" class="form-control" id="combinedSaves" name="saves" min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="combinedPassCompleted">Passes completed</label>
                            <input type="number" class="form-control" id="combinedPassCompleted" name="passes_completed" min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="combinedPassAttempted">Passes attempted</label>
                            <input type="number" class="form-control" id="combinedPassAttempted" name="passes_attempted" min="0" value="0">
                        </div>
                    </div>
                </div>

                <!-- Custom Metrics -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="ph ph-plus-circle me-2"></i>Custom Statistics</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="addCustomMetricBtn">
                        <i class="ph ph-plus me-1"></i>Add Custom Stat
                    </button>
                </div>
                <small class="text-muted d-block mb-2">Add any additional statistics not listed above</small>
                <div id="customMetricsContainer" class="d-flex flex-column gap-2 mb-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Statistics</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteScorerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" method="post" id="deleteScorerForm">
            <input type="hidden" name="delete" value="1">
            <input type="hidden" name="deleteEntityId" id="deleteScorerId">
            <div class="modal-header">
                <h5 class="modal-title">Remove scorer record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to remove <strong id="deleteScorerName"></strong> from the leaderboard?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const leaderboardData = {{ leaderboard|tojson }};
const advancedMetricsMap = {{ advanced_metrics_map|tojson }};
const sportConfigs = {{ sport_configs|tojson }};
const leagues = {{ leagues|tojson }};
const basicModal = new bootstrap.Modal(document.getElementById('basicStatsModal'));
const deleteModal = new bootstrap.Modal(document.getElementById('deleteScorerModal'));

function findLeaderboardEntry(scorerId){
    return leaderboardData.find(item => item.scorer_id === scorerId);
}

function openBasicModal(scorerId){
    const form = document.getElementById('combinedStatsForm');
    form.reset();
    document.getElementById('basicScorerId').value = scorerId || '';
    const title = document.getElementById('basicModalTitle');

    if (scorerId){
        const entry = findLeaderboardEntry(scorerId);
        const metrics = advancedMetricsMap[String(scorerId)] || {};

        if (!entry){
            console.warn('Entry not found for scorer', scorerId);
        } else {
            // Basic Info
            document.getElementById('basicPlayer').value = entry.player_id;
            document.getElementById('basicSeason').value = entry.season_id;
            document.getElementById('basicLeague').value = entry.league_id;

            // Basic Stats
            document.getElementById('basicGoals').value = entry.goals;
            document.getElementById('basicAssists').value = entry.assists;
            document.getElementById('basicPenalties').value = entry.penalties;

            // Advanced Stats
            document.getElementById('combinedRating').value = metrics.rating ?? '';
            document.getElementById('combinedGames').value = metrics.games_played || 0;
            document.getElementById('combinedMinutes').value = metrics.minutes_played || 0;

            // Legacy Stats
            document.getElementById('combinedShotsOnTarget').value = metrics.shots_on_target || 0;
            document.getElementById('combinedShotAttempts').value = metrics.shot_attempts || 0;
            document.getElementById('combinedSaves').value = metrics.saves || 0;
            document.getElementById('combinedPassCompleted').value = metrics.passes_completed || 0;
            document.getElementById('combinedPassAttempted').value = metrics.passes_attempted || 0;

            // Generate sport-specific stats
            const leagueId = entry.league_id;
            if (leagueId && sportConfigs[leagueId]) {
                generateSportSpecificStats(leagueId, metrics.custom_metrics || {});
            }

            // Populate custom metrics
            populateCustomMetrics(metrics.custom_metrics || {});
        }
        title.textContent = 'Edit Player Statistics';
    } else {
        title.textContent = 'Add Player Statistics';
        populateCustomMetrics({});
    }

    // Trigger league change to show sport-specific fields
    onLeagueChange();
    basicModal.show();
}

function addCustomMetricRow(name = '', value = ''){
    const container = document.getElementById('customMetricsContainer');
    const row = document.createElement('div');
    row.className = 'input-group';
    row.innerHTML = `
        <span class="input-group-text bg-white">Label</span>
        <input type="text" class="form-control" placeholder="xG, plus-minus, etc." value="${name.replace(/"/g,'&quot;')}" data-metric-name>
        <span class="input-group-text bg-white">Value</span>
        <input type="text" class="form-control" value="${value}" data-metric-value>
        <button class="btn btn-outline-danger" type="button"><i class="ph ph-x"></i></button>
    `;
    row.querySelector('button').addEventListener('click', () => row.remove());
    container.appendChild(row);
}

function populateCustomMetrics(metrics){
    const container = document.getElementById('customMetricsContainer');
    container.innerHTML = '';
    if (metrics && Object.keys(metrics).length){
        Object.entries(metrics).forEach(([key,value]) => addCustomMetricRow(key, value));
    } else {
        addCustomMetricRow();
    }
}

function onLeagueChange() {
    const leagueSelect = document.getElementById('basicLeague');
    const leagueId = leagueSelect.value;
    const sportSection = document.getElementById('sportSpecificSection');
    const sportHelp = document.getElementById('basicSportHelp');
    const sportNameSpan = document.getElementById('basicSportName');

    if (!leagueId || !sportConfigs[leagueId]) {
        sportSection.classList.add('d-none');
        sportHelp.classList.add('d-none');
        return;
    }

    const config = sportConfigs[leagueId];

    // Update sport help banner
    sportNameSpan.textContent = config.display_name;
    sportHelp.classList.remove('d-none');

    // Generate sport-specific stat fields
    generateSportSpecificStats(leagueId, {});

    // Show the section
    sportSection.classList.remove('d-none');
}

function generateSportSpecificStats(leagueId, existingStats) {
    const config = sportConfigs[leagueId];
    if (!config) return;

    const container = document.getElementById('sportSpecificStatsContainer');
    const sportSection = document.getElementById('sportSpecificSection');

    // Clear container
    container.innerHTML = '';

    // Generate fields for each stat in the sport config (skip the first 3 which are covered by basic stats)
    const statsToShow = config.player_stats.slice(3); // Skip goals/points, assists, penalties which are in basic

    if (statsToShow.length > 0) {
        statsToShow.forEach(stat => {
            const col = document.createElement('div');
            col.className = 'col-md-4';

            const label = document.createElement('label');
            label.className = 'form-label';
            label.innerHTML = `${stat.label} <span class="badge bg-secondary-subtle text-secondary-emphasis">${stat.abbr}</span>`;

            const input = document.createElement('input');
            input.type = stat.type === 'float' ? 'number' : 'number';
            input.step = stat.type === 'float' ? '0.01' : '1';
            input.className = 'form-control';
            input.name = `sport_stat_${stat.key}`;
            input.id = `sportStat_${stat.key}`;
            input.min = '0';
            input.value = existingStats[stat.key] || 0;

            col.appendChild(label);
            col.appendChild(input);
            container.appendChild(col);
        });

        sportSection.classList.remove('d-none');
    } else {
        sportSection.classList.add('d-none');
    }
}

function confirmDelete(scorerId, name){
    document.getElementById('deleteScorerId').value = scorerId;
    document.getElementById('deleteScorerName').textContent = name;
    deleteModal.show();
}

function serializeCustomMetrics(){
    const payload = {};

    // Collect sport-specific stats
    const sportStatInputs = document.querySelectorAll('[name^="sport_stat_"]');
    sportStatInputs.forEach(input => {
        const statKey = input.name.replace('sport_stat_', '');
        const value = input.value.trim();
        if (value && value !== '0') {
            payload[statKey] = value;
        }
    });

    // Collect additional custom metrics
    const rows = document.querySelectorAll('#customMetricsContainer [data-metric-name]');
    rows.forEach(row => {
        const name = row.value.trim();
        const valueInput = row.parentElement.querySelector('[data-metric-value]');
        const value = valueInput.value.trim();
        if (name){ payload[name] = value; }
    });

    document.getElementById('combinedCustomMetrics').value = JSON.stringify(payload);
}

document.getElementById('combinedStatsForm').addEventListener('submit', serializeCustomMetrics);
document.getElementById('addCustomMetricBtn').addEventListener('click', () => addCustomMetricRow());

function applyLeaderboardFilters(){
    const searchTerm = (document.getElementById('leaderboardSearch').value || '').toLowerCase();
    const seasonFilter = document.getElementById('filterSeason').value;
    const leagueFilter = document.getElementById('filterLeague').value;
    const ratingFilter = document.getElementById('filterRating').value;
    const rows = document.querySelectorAll('#leaderboardTable tbody tr');

    rows.forEach(row => {
        const player = row.dataset.player || '';
        const league = row.dataset.league || '';
        const season = row.dataset.season || '';
        const rating = parseFloat(row.dataset.rating || '0');

        const matchesSearch = !searchTerm || player.includes(searchTerm) || row.textContent.toLowerCase().includes(searchTerm);
        const matchesSeason = !seasonFilter || season === seasonFilter;
        const matchesLeague = !leagueFilter || league === leagueFilter;
        const matchesRating = !ratingFilter || (rating && rating >= parseFloat(ratingFilter));

        row.style.display = (matchesSearch && matchesSeason && matchesLeague && matchesRating) ? '' : 'none';
    });
}

['leaderboardSearch','filterSeason','filterLeague','filterRating'].forEach(id => {
    const el = document.getElementById(id);
    if (el){ el.addEventListener('input', applyLeaderboardFilters); el.addEventListener('change', applyLeaderboardFilters); }
});

applyLeaderboardFilters();

// Sorting functionality
let currentSort = { column: null, direction: 'asc' };

function sortTable(column) {
    const tbody = document.querySelector('#leaderboardTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Determine sort direction
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.direction = 'asc';
    }
    currentSort.column = column;

    // Update header styling
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });
    const activeHeader = document.querySelector(`[data-sort="${column}"]`);
    activeHeader.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');

    // Sort rows
    rows.sort((a, b) => {
        let aVal, bVal;

        switch (column) {
            case 'player':
                aVal = a.dataset.playerName || '';
                bVal = b.dataset.playerName || '';
                return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);

            case 'league':
                aVal = (a.dataset.leagueName || '') + ' ' + (a.dataset.seasonYear || '');
                bVal = (b.dataset.leagueName || '') + ' ' + (b.dataset.seasonYear || '');
                return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);

            case 'goals':
            case 'assists':
            case 'contributions':
            case 'momentum':
                aVal = parseFloat(a.dataset[column.replace('-', '')]) || 0;
                bVal = parseFloat(b.dataset[column.replace('-', '')]) || 0;
                break;

            case 'per-match':
                aVal = parseFloat(a.dataset.perMatch) || 0;
                bVal = parseFloat(b.dataset.perMatch) || 0;
                break;

            case 'per-90':
                aVal = parseFloat(a.dataset.per90) || 0;
                bVal = parseFloat(b.dataset.per90) || 0;
                break;

            case 'shot-accuracy':
                aVal = parseFloat(a.dataset.shotAccuracy) || 0;
                bVal = parseFloat(b.dataset.shotAccuracy) || 0;
                break;

            case 'pass-accuracy':
                aVal = parseFloat(a.dataset.passAccuracy) || 0;
                bVal = parseFloat(b.dataset.passAccuracy) || 0;
                break;

            case 'rating':
                aVal = parseFloat(a.dataset.rating) || 0;
                bVal = parseFloat(b.dataset.rating) || 0;
                break;

            default:
                return 0;
        }

        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });

    // Re-append sorted rows and update rank numbers
    rows.forEach((row, index) => {
        tbody.appendChild(row);
        // Update rank pill
        const rankPill = row.querySelector('.rank-pill');
        if (rankPill) {
            rankPill.textContent = index + 1;
            // Remove special styling from rank 1
            rankPill.classList.remove('shadow');
            if (index === 0) {
                rankPill.classList.add('shadow');
            }
        }
    });
}

// Add click event listeners to sortable headers
document.querySelectorAll('.sortable-header').forEach(header => {
    header.addEventListener('click', () => {
        const column = header.dataset.sort;
        sortTable(column);
    });
});

// Sport-specific functionality
function updateSportIndicator(leagueId) {
    const league = leagues.find(l => l.id == leagueId);
    if (!league || !sportConfigs[leagueId]) {
        document.getElementById('sportIndicator').classList.add('d-none');
        return;
    }

    const config = sportConfigs[leagueId];
    const sportName = config.display_name || league.sport;
    const primaryStats = config.player_stats.slice(0, 5).map(s => s.label).join(', ');

    document.getElementById('sportName').textContent = sportName;
    document.getElementById('sportPrimaryStats').textContent = primaryStats + '...';
    document.getElementById('sportIndicator').classList.remove('d-none');
}

function updateBasicModalSportInfo(leagueId) {
    const league = leagues.find(l => l.id == leagueId);
    if (!league || !sportConfigs[leagueId]) {
        document.getElementById('basicSportHelp').classList.add('d-none');
        document.getElementById('basicGoalsLabel').textContent = 'Goals';
        return;
    }

    const config = sportConfigs[leagueId];
    const sportName = config.display_name || league.sport;

    // Update sport name
    document.getElementById('basicSportName').textContent = sportName;

    // List primary stats
    const statsList = config.player_stats.slice(0, 8).map(s =>
        `<span class="badge bg-primary-subtle text-primary me-1 mb-1">${s.label} (${s.abbr})</span>`
    ).join('');
    document.getElementById('basicSportStatsList').innerHTML = statsList;

    // Update "Goals" label based on sport
    const primaryStat = config.scoring_type;
    if (primaryStat === 'points') {
        document.getElementById('basicGoalsLabel').textContent = 'Points';
    } else if (primaryStat === 'runs') {
        document.getElementById('basicGoalsLabel').textContent = 'Runs';
    } else if (primaryStat === 'kills') {
        document.getElementById('basicGoalsLabel').textContent = 'Kills';
    } else if (primaryStat === 'tries') {
        document.getElementById('basicGoalsLabel').textContent = 'Tries';
    } else {
        document.getElementById('basicGoalsLabel').textContent = 'Goals';
    }

    document.getElementById('basicSportHelp').classList.remove('d-none');
}

// Event listeners for sport-aware UI
document.getElementById('filterLeague').addEventListener('change', function() {
    const leagueId = this.value;
    if (leagueId) {
        updateSportIndicator(leagueId);
    } else {
        document.getElementById('sportIndicator').classList.add('d-none');
    }
});

document.getElementById('basicLeague').addEventListener('change', function() {
    const leagueId = this.value;
    if (leagueId) {
        updateBasicModalSportInfo(leagueId);
    } else {
        document.getElementById('basicSportHelp').classList.add('d-none');
    }
});
</script>
{% endblock %}
