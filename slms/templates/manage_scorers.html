{% extends "base.html" %}
{% block title %}Scoring Leaderboard - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.leaderboard-page .stat-card{border:none;border-radius:1rem;box-shadow:0 10px 30px rgba(15,23,42,0.08);} 
.leaderboard-page .stat-label{font-size:0.85rem;text-transform:uppercase;letter-spacing:0.06em;}
.leaderboard-card{border:none;border-radius:1rem;box-shadow:0 18px 44px rgba(15,23,42,0.08);} 
.leaderboard-card .card-header{border-bottom:1px solid rgba(15,23,42,0.05);} 
.leaderboard-table th{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#6b7280;border-top:none;border-bottom:1px solid rgba(148,163,184,0.35);} 
.leaderboard-table td{vertical-align:middle;border-bottom:1px solid rgba(148,163,184,0.15);} 
.rank-pill{display:inline-flex;align-items:center;justify-content:center;width:2.5rem;height:2.5rem;border-radius:0.85rem;font-weight:600;background:linear-gradient(135deg,var(--slms-gradient-start,#2563eb),var(--slms-gradient-end,#1d4ed8));color:#fff;} 
.momentum-meter{height:0.5rem;border-radius:999px;background-color:rgba(148,163,184,0.25);overflow:hidden;} 
.momentum-meter .fill{height:100%;background:linear-gradient(90deg,#22c55e,#0ea5e9);} 
.metric-badge{display:inline-flex;align-items:center;gap:0.35rem;padding:0.35rem 0.65rem;border-radius:999px;font-size:0.75rem;background-color:rgba(37,99,235,0.08);color:#1e3a8a;} 
.metric-badge .label{font-weight:600;text-transform:uppercase;letter-spacing:0.05em;} 
.metric-badge .value{font-weight:600;} 
.leaderboard-actions .btn{border-radius:0.65rem;} 
.analytics-card{border:none;border-radius:1rem;box-shadow:0 14px 32px rgba(15,23,42,0.08);position:relative;overflow:hidden;} 
.analytics-card .accent{position:absolute;inset:0;opacity:0.08;pointer-events:none;background:linear-gradient(135deg,var(--slms-gradient-start,#2563eb),var(--slms-gradient-end,#1d4ed8));} 
.analytics-card .card-body{position:relative;} 
.custom-metric-table th,.custom-metric-table td{padding:0.75rem;} 
.search-group .form-control{min-width:240px;} 
@media(max-width:992px){.leaderboard-page .search-group .form-control{min-width:unset;width:220px;}}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 leaderboard-page">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Scoring Leaderboard</h1>
            <p class="text-muted mb-0">Compare top performers, reveal momentum, and manage advanced analytics across every competition.</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="input-group search-group shadow-sm">
                <span class="input-group-text bg-white border-end-0"><i class="ph ph-magnifying-glass"></i></span>
                <input type="search" class="form-control border-start-0" id="leaderboardSearch" placeholder="Search player, league, or season">
            </div>
            <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#leaderboardFilters" type="button">
                <i class="ph ph-funnel me-2"></i>Filters
            </button>
            <button class="btn btn-primary" type="button" onclick="openBasicModal()">
                <i class="ph ph-plus me-2"></i>Add Player Stats
            </button>
        </div>
    </div>

    <div class="collapse mb-4" id="leaderboardFilters">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterSeason">Season</label>
                        <select class="form-select" id="filterSeason">
                            <option value="">All Seasons</option>
                            {% for season in seasons %}
                                <option value="{{ season[0] }}">{{ season[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterLeague">League</label>
                        <select class="form-select" id="filterLeague">
                            <option value="">All Leagues</option>
                            {% for league in leagues %}
                                <option value="{{ league[0] }}">{{ league[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase text-muted" for="filterRating">Minimum Rating</label>
                        <select class="form-select" id="filterRating">
                            <option value="">All Ratings</option>
                            <option value="70">70+</option>
                            <option value="75">75+</option>
                            <option value="80">80+</option>
                            <option value="85">85+</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Active players</div>
                <div class="d-flex align-items-baseline gap-2">
                    <span class="fs-3 fw-bold">{{ analytics_summary.total_players }}</span>
                    <span class="text-success small fw-semibold">Leaderboard depth</span>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Total goals</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.total_goals }}</div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Goal contributions</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.total_goals + analytics_summary.total_assists }}</div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card p-3 h-100">
                <div class="stat-label text-muted mb-2">Average rating</div>
                <div class="fs-3 fw-bold">{{ analytics_summary.avg_rating or '?' }}</div>
            </div>
        </div>
    </div>

    <div class="card leaderboard-card mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div>
                    <h2 class="h5 mb-0">Leaderboard</h2>
                    <small class="text-muted">Sorted by composite momentum score.</small>
                </div>
                <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">{{ leaderboard|length }} entries</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table leaderboard-table align-middle mb-0" id="leaderboardTable">
                <thead>
                    <tr>
                        <th scope="col">Rank</th>
                        <th scope="col">Player</th>
                        <th scope="col">League / Season</th>
                        <th scope="col">Goals</th>
                        <th scope="col">Assists</th>
                        <th scope="col">G + A</th>
                        <th scope="col">Per Match</th>
                        <th scope="col">Per 90</th>
                        <th scope="col">Shot %</th>
                        <th scope="col">Pass %</th>
                        <th scope="col">Rating</th>
                        <th scope="col" style="width:160px;">Momentum</th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in leaderboard %}
                    <tr data-player="{{ entry.player_name|lower }}" data-league="{{ entry.league_id }}" data-season="{{ entry.season_id }}" data-rating="{{ entry.rating or '' }}">
                        <td>
                            <div class="rank-pill{% if entry.rank == 1 %} shadow{% endif %}">{{ entry.rank }}</div>
                        </td>
                        <td>
                            <div class="fw-semibold text-dark">{{ entry.player_name }}</div>
                            <div class="text-muted small">{{ entry.games_played }} games ? {{ entry.minutes_played }} mins</div>
                            {% if entry.custom_metrics %}
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    {% for label, value in entry.custom_metrics.items() %}
                                        <span class="badge rounded-pill bg-light text-secondary border">{{ label }}: {{ value }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-semibold">{{ entry.league_name }}</div>
                            <div class="text-muted small">{{ entry.season_year }}</div>
                        </td>
                        <td class="fw-bold text-primary">{{ entry.goals }}</td>
                        <td class="fw-bold text-success">{{ entry.assists }}</td>
                        <td class="fw-bold">{{ entry.goal_contributions }}</td>
                        <td>{{ entry.per_game_contribution|round(2) if entry.per_game_contribution is not none else '?' }}</td>
                        <td>{{ entry.per_90_contribution|round(2) if entry.per_90_contribution is not none else '?' }}</td>
                        <td>{{ (entry.shot_accuracy * 100)|round(1) if entry.shot_accuracy is not none else '?' }}{% if entry.shot_accuracy is not none %}%{% endif %}</td>
                        <td>{{ (entry.pass_accuracy * 100)|round(1) if entry.pass_accuracy is not none else '?' }}{% if entry.pass_accuracy is not none %}%{% endif %}</td>
                        <td>{{ entry.rating|round(1) if entry.rating is not none else '?' }}</td>
                        <td>
                            <div class="momentum-meter">
                                <div class="fill" style="width: {{ entry.momentum }}%;"></div>
                            </div>
                            <small class="text-muted d-block mt-1">{{ entry.analytics_score|round(1) }}</small>
                        </td>
                        <td class="text-end leaderboard-actions">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="openBasicModal({{ entry.scorer_id }})">Edit</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="openAdvancedModal({{ entry.scorer_id }})">Advanced</button>
                                <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ entry.scorer_id }}, {{ entry.player_name|tojson }})">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="13" class="py-5 text-center text-muted">No scorer data available yet. Add player statistics to populate the leaderboard.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Top Scorer</div>
                    {% if analytics_summary.top_goal_scorer %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.top_goal_scorer.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.top_goal_scorer.goals }} goals ? {{ analytics_summary.top_goal_scorer.assists }} assists</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Assist Leader</div>
                    {% if analytics_summary.top_assist_player %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.top_assist_player.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.top_assist_player.assists }} assists</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Efficiency</div>
                    {% if analytics_summary.most_efficient %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.most_efficient.player_name }}</h5>
                        <div class="text-muted small">{{ analytics_summary.most_efficient.per_game_contribution|round(2) }} contributions / match</div>
                    {% else %}
                        <div class="text-muted">No data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card analytics-card h-100">
                <div class="accent"></div>
                <div class="card-body">
                    <div class="text-muted text-uppercase small mb-2">Highest Rating</div>
                    {% if analytics_summary.best_rating %}
                        <h5 class="fw-semibold mb-1">{{ analytics_summary.best_rating.player_name }}</h5>
                        <div class="text-muted small">Rating {{ analytics_summary.best_rating.rating|round(1) }}</div>
                    {% else %}
                        <div class="text-muted">No rating data</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if custom_metric_summary %}
    <div class="card shadow-sm rounded-4 mt-4">
        <div class="card-header bg-white py-3">
            <h2 class="h6 mb-0">Custom Metric Spotlight</h2>
        </div>
        <div class="table-responsive">
            <table class="table custom-metric-table mb-0">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Average</th>
                        <th>Peak Value</th>
                        <th>Leaderboard</th>
                    </tr>
                </thead>
                <tbody>
                    {% for metric, snapshot in custom_metric_summary.items() %}
                        <tr>
                            <td class="fw-semibold">{{ metric }}</td>
                            <td>{{ snapshot.average }}</td>
                            <td>{{ snapshot.max }}</td>
                            <td>{{ snapshot.leader }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Base Stats Modal -->
<div class="modal fade" id="basicStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form class="modal-content" method="post" id="basicStatsForm">
            <input type="hidden" name="action" value="basic">
            <input type="hidden" name="scorer_id" id="basicScorerId">
            <div class="modal-header">
                <h5 class="modal-title" id="basicModalTitle">Add Player Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="basicPlayer">Player</label>
                        <select class="form-select" name="player_id" id="basicPlayer" required>
                            <option value="">Select player</option>
                            {% for player in players %}
                                <option value="{{ player[0] }}">{{ player[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicSeason">Season</label>
                        <select class="form-select" name="season_id" id="basicSeason" required>
                            <option value="">Select season</option>
                            {% for season in seasons %}
                                <option value="{{ season[0] }}">{{ season[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="basicLeague">League</label>
                        <select class="form-select" name="league_id" id="basicLeague" required>
                            <option value="">Select league</option>
                            {% for league in leagues %}
                                <option value="{{ league[0] }}">{{ league[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="basicGoals">Goals</label>
                        <input type="number" class="form-control" name="goals" id="basicGoals" min="0" value="0" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="basicAssists">Assists</label>
                        <input type="number" class="form-control" name="assists" id="basicAssists" min="0" value="0" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="basicPenalties">Penalties</label>
                        <input type="number" class="form-control" name="penalties" id="basicPenalties" min="0" value="0" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Stats</button>
            </div>
        </form>
    </div>
</div>

<!-- Advanced Stats Modal -->
<div class="modal fade" id="advancedStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <form class="modal-content" method="post" id="advancedStatsForm">
            <input type="hidden" name="action" value="advanced">
            <input type="hidden" name="scorer_id" id="advancedScorerId">
            <input type="hidden" name="custom_metrics_json" id="advancedCustomMetrics">
            <div class="modal-header">
                <h5 class="modal-title" id="advancedModalTitle">Advanced Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label" for="advancedGames">Games played</label>
                        <input type="number" class="form-control" id="advancedGames" name="games_played" min="0" value="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="advancedMinutes">Minutes played</label>
                        <input type="number" class="form-control" id="advancedMinutes" name="minutes_played" min="0" value="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="advancedRating">Performance rating</label>
                        <input type="number" step="0.1" class="form-control" id="advancedRating" name="rating" min="0" max="100">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="advancedShotsOnTarget">Shots on target</label>
                        <input type="number" class="form-control" id="advancedShotsOnTarget" name="shots_on_target" min="0" value="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="advancedShotAttempts">Total shot attempts</label>
                        <input type="number" class="form-control" id="advancedShotAttempts" name="shot_attempts" min="0" value="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="advancedSaves">Saves / blocks</label>
                        <input type="number" class="form-control" id="advancedSaves" name="saves" min="0" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="advancedPassCompleted">Passes completed</label>
                        <input type="number" class="form-control" id="advancedPassCompleted" name="passes_completed" min="0" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="advancedPassAttempted">Passes attempted</label>
                        <input type="number" class="form-control" id="advancedPassAttempted" name="passes_attempted" min="0" value="0">
                    </div>
                </div>
                <hr class="my-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Custom Metrics</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="addCustomMetricBtn"><i class="ph ph-plus me-1"></i>Add Metric</button>
                </div>
                <div id="customMetricsContainer" class="d-flex flex-column gap-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Analytics</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteScorerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" method="post" id="deleteScorerForm">
            <input type="hidden" name="delete" value="1">
            <input type="hidden" name="deleteEntityId" id="deleteScorerId">
            <div class="modal-header">
                <h5 class="modal-title">Remove scorer record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to remove <strong id="deleteScorerName"></strong> from the leaderboard?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const leaderboardData = {{ leaderboard|tojson }};
const advancedMetricsMap = {{ advanced_metrics_map|tojson }};
const basicModal = new bootstrap.Modal(document.getElementById('basicStatsModal'));
const advancedModal = new bootstrap.Modal(document.getElementById('advancedStatsModal'));
const deleteModal = new bootstrap.Modal(document.getElementById('deleteScorerModal'));

function findLeaderboardEntry(scorerId){
    return leaderboardData.find(item => item.scorer_id === scorerId);
}

function openBasicModal(scorerId){
    const form = document.getElementById('basicStatsForm');
    form.reset();
    document.getElementById('basicScorerId').value = scorerId || '';
    const title = document.getElementById('basicModalTitle');
    if (scorerId){
        const entry = findLeaderboardEntry(scorerId);
        if (!entry){
            console.warn('Entry not found for scorer', scorerId);
        } else {
            document.getElementById('basicPlayer').value = entry.player_id;
            document.getElementById('basicSeason').value = entry.season_id;
            document.getElementById('basicLeague').value = entry.league_id;
            document.getElementById('basicGoals').value = entry.goals;
            document.getElementById('basicAssists').value = entry.assists;
            document.getElementById('basicPenalties').value = entry.penalties;
        }
        title.textContent = 'Edit Player Statistics';
    } else {
        title.textContent = 'Add Player Statistics';
    }
    basicModal.show();
}

function addCustomMetricRow(name = '', value = ''){
    const container = document.getElementById('customMetricsContainer');
    const row = document.createElement('div');
    row.className = 'input-group';
    row.innerHTML = `
        <span class="input-group-text bg-white">Label</span>
        <input type="text" class="form-control" placeholder="xG, plus-minus, etc." value="${name.replace(/"/g,'&quot;')}" data-metric-name>
        <span class="input-group-text bg-white">Value</span>
        <input type="text" class="form-control" value="${value}" data-metric-value>
        <button class="btn btn-outline-danger" type="button"><i class="ph ph-x"></i></button>
    `;
    row.querySelector('button').addEventListener('click', () => row.remove());
    container.appendChild(row);
}

function populateCustomMetrics(metrics){
    const container = document.getElementById('customMetricsContainer');
    container.innerHTML = '';
    if (metrics && Object.keys(metrics).length){
        Object.entries(metrics).forEach(([key,value]) => addCustomMetricRow(key, value));
    } else {
        addCustomMetricRow();
    }
}

function openAdvancedModal(scorerId){
    const metrics = advancedMetricsMap[String(scorerId)] || {};
    document.getElementById('advancedScorerId').value = scorerId;
    document.getElementById('advancedGames').value = metrics.games_played || 0;
    document.getElementById('advancedMinutes').value = metrics.minutes_played || 0;
    document.getElementById('advancedRating').value = metrics.rating ?? '';
    document.getElementById('advancedShotsOnTarget').value = metrics.shots_on_target || 0;
    document.getElementById('advancedShotAttempts').value = metrics.shot_attempts || 0;
    document.getElementById('advancedSaves').value = metrics.saves || 0;
    document.getElementById('advancedPassCompleted').value = metrics.passes_completed || 0;
    document.getElementById('advancedPassAttempted').value = metrics.passes_attempted || 0;
    populateCustomMetrics(metrics.custom_metrics || {});
    const entry = findLeaderboardEntry(scorerId);
    const title = document.getElementById('advancedModalTitle');
    title.textContent = entry ? `Advanced Analytics ? ${entry.player_name}` : 'Advanced Analytics';
    advancedModal.show();
}

function confirmDelete(scorerId, name){
    document.getElementById('deleteScorerId').value = scorerId;
    document.getElementById('deleteScorerName').textContent = name;
    deleteModal.show();
}

function serializeCustomMetrics(){
    const rows = document.querySelectorAll('#customMetricsContainer [data-metric-name]');
    const payload = {};
    rows.forEach(row => {
        const name = row.value.trim();
        const valueInput = row.parentElement.querySelector('[data-metric-value]');
        const value = valueInput.value.trim();
        if (name){ payload[name] = value; }
    });
    document.getElementById('advancedCustomMetrics').value = JSON.stringify(payload);
}

document.getElementById('advancedStatsForm').addEventListener('submit', serializeCustomMetrics);
document.getElementById('addCustomMetricBtn').addEventListener('click', () => addCustomMetricRow());

function applyLeaderboardFilters(){
    const searchTerm = (document.getElementById('leaderboardSearch').value || '').toLowerCase();
    const seasonFilter = document.getElementById('filterSeason').value;
    const leagueFilter = document.getElementById('filterLeague').value;
    const ratingFilter = document.getElementById('filterRating').value;
    const rows = document.querySelectorAll('#leaderboardTable tbody tr');

    rows.forEach(row => {
        const player = row.dataset.player || '';
        const league = row.dataset.league || '';
        const season = row.dataset.season || '';
        const rating = parseFloat(row.dataset.rating || '0');

        const matchesSearch = !searchTerm || player.includes(searchTerm) || row.textContent.toLowerCase().includes(searchTerm);
        const matchesSeason = !seasonFilter || season === seasonFilter;
        const matchesLeague = !leagueFilter || league === leagueFilter;
        const matchesRating = !ratingFilter || (rating && rating >= parseFloat(ratingFilter));

        row.style.display = (matchesSearch && matchesSeason && matchesLeague && matchesRating) ? '' : 'none';
    });
}

['leaderboardSearch','filterSeason','filterLeague','filterRating'].forEach(id => {
    const el = document.getElementById(id);
    if (el){ el.addEventListener('input', applyLeaderboardFilters); el.addEventListener('change', applyLeaderboardFilters); }
});

applyLeaderboardFilters();
</script>
{% endblock %}
