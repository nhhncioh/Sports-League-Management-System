{% extends "base.html" %}
{% block title %}Match Creation & Scheduling - Admin Panel{% endblock %}

{% block head %}
<style>
.match-creation-hub {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
}

.creation-method-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.creation-method-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: #667eea;
}

.creation-method-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.wizard-step {
    display: none;
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.wizard-step.active {
    display: block;
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step-indicator .step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 0.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.step-indicator .step.completed {
    background: #28a745;
    color: white;
}

.step-indicator .step.active {
    background: #667eea;
    color: white;
}

.step-indicator .step-line {
    width: 60px;
    height: 2px;
    background: #e9ecef;
    margin-top: 19px;
}

.step-indicator .step-line.completed {
    background: #28a745;
}

.match-preview-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

.existing-matches-section {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.match-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.match-item:hover {
    background: #e9ecef;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-scheduled {
    background: #fff3cd;
    color: #856404;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-live {
    background: #f8d7da;
    color: #721c24;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="match-creation-hub">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2"><i class="ph ph-calendar-plus me-2"></i>Match Creation & Scheduling</h1>
                <p class="mb-0 opacity-75">Create individual matches or bulk generate fixtures for your leagues</p>
            </div>
            <div class="text-center">
                <div class="display-6 fw-bold">{{ total_matches }}</div>
                <small class="opacity-75">Total Matches</small>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Match Creation Methods -->
        <div class="col-lg-8">
            <h3 class="mb-3">Choose Creation Method</h3>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="creation-method-card" onclick="selectCreationMethod('single')">
                        <div class="text-center">
                            <i class="ph ph-plus-circle display-4 text-primary mb-3"></i>
                            <h5>Single Match</h5>
                            <p class="text-muted small">Create one match at a time</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="creation-method-card" onclick="selectCreationMethod('round-robin')">
                        <div class="text-center">
                            <i class="ph ph-arrows-clockwise display-4 text-success mb-3"></i>
                            <h5>Round Robin</h5>
                            <p class="text-muted small">Each team plays each other (1x or 2x)</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="creation-method-card" onclick="selectCreationMethod('custom-bulk')">
                        <div class="text-center">
                            <i class="ph ph-stack display-4 text-warning mb-3"></i>
                            <h5>Custom Bulk</h5>
                            <p class="text-muted small">Advanced fixture generation</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Single Match Creation -->
            <div id="single-match-wizard" class="wizard-step">
                <h4 class="mb-3">Create Single Match</h4>
                <form method="post" action="{{ url_for('admin.manage_matches') }}">
                    <input type="hidden" name="action" value="create_single">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">League</label>
                            <select class="form-select" name="league_id" required onchange="loadSeasons(this.value)">
                                <option value="">Select League</option>
                                {% for league in leagues %}
                                <option value="{{ league.league_id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Season</label>
                            <select class="form-select" name="season_id" id="seasonSelect" required>
                                <option value="">Select Season</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Home Team</label>
                            <select class="form-select" name="home_team_id" required>
                                <option value="">Select Home Team</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Away Team</label>
                            <select class="form-select" name="away_team_id" required>
                                <option value="">Select Away Team</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Match Date</label>
                            <input type="date" class="form-control" name="match_date" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Match Time</label>
                            <input type="time" class="form-control" name="match_time">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Matchday</label>
                            <input type="number" class="form-control" name="matchday" min="1">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Venue</label>
                            <select class="form-select" name="venue_id">
                                <option value="">Select Venue</option>
                                {% for venue in venues %}
                                <option value="{{ venue.venue_id }}">{{ venue.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="ph ph-plus me-2"></i>Create Match
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="clearCreationMethod()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Round Robin Wizard -->
            <div id="round-robin-wizard" class="wizard-step">
                <div class="step-indicator">
                    <div class="step active" id="rr-step-1">1</div>
                    <div class="step-line"></div>
                    <div class="step" id="rr-step-2">2</div>
                    <div class="step-line"></div>
                    <div class="step" id="rr-step-3">3</div>
                </div>

                <form method="post" action="{{ url_for('admin.manage_matches') }}" id="roundRobinForm">
                    <input type="hidden" name="action" value="create_round_robin">

                    <!-- Step 1: Basic Settings -->
                    <div class="wizard-content" id="rr-content-1">
                        <h4 class="mb-3">Round Robin Settings</h4>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">League</label>
                                <select class="form-select" name="rr_league_id" required>
                                    <option value="">Select League</option>
                                    {% for league in leagues %}
                                    <option value="{{ league.league_id }}">{{ league.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Season</label>
                                <select class="form-select" name="rr_season_id" required>
                                    <option value="">Select Season</option>
                                    {% for season in seasons %}
                                    <option value="{{ season.season_id }}">{{ season.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Fixture Type</label>
                                <select class="form-select" name="fixture_type" required>
                                    <option value="single">Single Round Robin (Each team plays once)</option>
                                    <option value="double">Double Round Robin (Each team plays twice)</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="start_date" required>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-primary" onclick="nextRRStep(2)">
                                Next <i class="ph ph-arrow-right ms-2"></i>
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="clearCreationMethod()">Cancel</button>
                        </div>
                    </div>

                    <!-- Step 2: Team Selection -->
                    <div class="wizard-content" id="rr-content-2" style="display: none;">
                        <h4 class="mb-3">Select Teams</h4>

                        <div class="row">
                            <div class="col-md-8">
                                <h6>Available Teams</h6>
                                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    {% for team in teams %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="selected_teams"
                                               value="{{ team.team_id }}" id="team-{{ team.team_id }}">
                                        <label class="form-check-label" for="team-{{ team.team_id }}">
                                            {{ team.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTeams()">Select All</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearAllTeams()">Clear All</button>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Fixture Preview</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="fixture-preview">
                                            <p class="text-muted small">Select teams to see fixture count</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-secondary" onclick="prevRRStep(1)">
                                <i class="ph ph-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-primary ms-2" onclick="nextRRStep(3)">
                                Next <i class="ph ph-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Review & Generate -->
                    <div class="wizard-content" id="rr-content-3" style="display: none;">
                        <h4 class="mb-3">Review & Generate</h4>

                        <div id="generation-preview"></div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-secondary" onclick="prevRRStep(2)">
                                <i class="ph ph-arrow-left me-2"></i>Previous
                            </button>
                            <button type="submit" class="btn btn-success ms-2">
                                <i class="ph ph-magic-wand me-2"></i>Generate Fixtures
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Custom Bulk Creation -->
            <div id="custom-bulk-wizard" class="wizard-step">
                <h4 class="mb-3">Custom Bulk Creation</h4>
                <div class="alert alert-info">
                    <i class="ph ph-info me-2"></i>
                    Advanced fixture generation coming soon. This will allow you to create custom tournament brackets,
                    group stages, and other complex fixture formats.
                </div>
            </div>
        </div>

        <!-- Existing Matches Sidebar -->
        <div class="col-lg-4">
            <div class="existing-matches-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Recent Matches</h5>
                    <a href="{{ url_for('admin.manage_scores') }}" class="btn btn-sm btn-outline-primary">
                        <i class="ph ph-pencil me-1"></i>Manage Scores
                    </a>
                </div>

                {% if recent_matches %}
                    {% for match in recent_matches %}
                    <div class="match-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="fw-bold">{{ match.home_team }} vs {{ match.away_team }}</div>
                                <small class="text-muted">{{ match.utc_date }} - Matchday {{ match.matchday }}</small>
                            </div>
                            <span class="status-badge status-{{ match.status }}">{{ match.status }}</span>
                        </div>

                        {% if match.status == 'completed' and match.home_score is not none %}
                        <div class="text-center py-2">
                            <span class="badge bg-light text-dark fs-6">{{ match.home_score }} - {{ match.away_score }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="ph ph-calendar-x display-6 mb-3"></i>
                        <p>No matches created yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let currentRRStep = 1;

function selectCreationMethod(method) {
    // Clear all selections
    document.querySelectorAll('.creation-method-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });

    // Select method and show wizard
    event.target.closest('.creation-method-card').classList.add('selected');
    document.getElementById(method + '-wizard').classList.add('active');
}

function clearCreationMethod() {
    document.querySelectorAll('.creation-method-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });
}

function nextRRStep(step) {
    // Hide current step
    document.getElementById(`rr-content-${currentRRStep}`).style.display = 'none';
    document.getElementById(`rr-step-${currentRRStep}`).classList.remove('active');
    document.getElementById(`rr-step-${currentRRStep}`).classList.add('completed');

    // Show next step
    currentRRStep = step;
    document.getElementById(`rr-content-${currentRRStep}`).style.display = 'block';
    document.getElementById(`rr-step-${currentRRStep}`).classList.add('active');

    // Update preview if on step 3
    if (step === 3) {
        updateGenerationPreview();
    }
}

function prevRRStep(step) {
    // Hide current step
    document.getElementById(`rr-content-${currentRRStep}`).style.display = 'none';
    document.getElementById(`rr-step-${currentRRStep}`).classList.remove('active');

    // Show previous step
    currentRRStep = step;
    document.getElementById(`rr-content-${currentRRStep}`).style.display = 'block';
    document.getElementById(`rr-step-${currentRRStep}`).classList.add('active');
    document.getElementById(`rr-step-${currentRRStep}`).classList.remove('completed');
}

function selectAllTeams() {
    document.querySelectorAll('input[name="selected_teams"]').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateFixturePreview();
}

function clearAllTeams() {
    document.querySelectorAll('input[name="selected_teams"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateFixturePreview();
}

function updateFixturePreview() {
    const selectedTeams = document.querySelectorAll('input[name="selected_teams"]:checked');
    const count = selectedTeams.length;
    const fixtureType = document.querySelector('select[name="fixture_type"]').value;

    if (count < 2) {
        document.getElementById('fixture-preview').innerHTML = '<p class="text-muted small">Select at least 2 teams</p>';
        return;
    }

    const matchesPerRound = count * (count - 1) / 2;
    const totalMatches = fixtureType === 'double' ? matchesPerRound * 2 : matchesPerRound;

    document.getElementById('fixture-preview').innerHTML = `
        <div class="text-center">
            <div class="display-6 text-primary">${totalMatches}</div>
            <small class="text-muted">Total Matches</small>
            <hr>
            <div><strong>${count}</strong> Teams</div>
            <div><strong>${fixtureType === 'double' ? '2' : '1'}</strong> Rounds</div>
        </div>
    `;
}

function updateGenerationPreview() {
    const selectedTeams = Array.from(document.querySelectorAll('input[name="selected_teams"]:checked'));
    const league = document.querySelector('select[name="rr_league_id"] option:checked').text;
    const season = document.querySelector('select[name="rr_season_id"] option:checked').text;
    const fixtureType = document.querySelector('select[name="fixture_type"]').value;
    const startDate = document.querySelector('input[name="start_date"]').value;

    const count = selectedTeams.length;
    const matchesPerRound = count * (count - 1) / 2;
    const totalMatches = fixtureType === 'double' ? matchesPerRound * 2 : matchesPerRound;

    document.getElementById('generation-preview').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Generation Summary</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <strong>League:</strong> ${league}<br>
                        <strong>Season:</strong> ${season}<br>
                        <strong>Start Date:</strong> ${startDate}
                    </div>
                    <div class="col-md-6">
                        <strong>Teams:</strong> ${count}<br>
                        <strong>Type:</strong> ${fixtureType === 'double' ? 'Double' : 'Single'} Round Robin<br>
                        <strong>Total Matches:</strong> ${totalMatches}
                    </div>
                </div>

                <hr>

                <h6>Selected Teams:</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${selectedTeams.map(team => `<span class="badge bg-primary">${team.nextElementSibling.textContent}</span>`).join('')}
                </div>
            </div>
        </div>
    `;
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Update fixture preview when teams are selected
    document.querySelectorAll('input[name="selected_teams"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateFixturePreview);
    });

    // Update preview when fixture type changes
    document.querySelector('select[name="fixture_type"]').addEventListener('change', updateFixturePreview);
});

function loadSeasons(leagueId) {
    if (!leagueId) {
        document.getElementById('seasonSelect').innerHTML = '<option value="">Select Season</option>';
        return;
    }

    fetch(`/admin/api/seasons/${leagueId}`)
        .then(response => response.json())
        .then(seasons => {
            const select = document.getElementById('seasonSelect');
            select.innerHTML = '<option value="">Select Season</option>';
            seasons.forEach(season => {
                select.innerHTML += `<option value="${season.season_id}">${season.name}</option>`;
            });
        });
}
</script>
{% endblock %}