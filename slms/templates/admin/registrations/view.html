{% extends "base.html" %}

{% block title %}Registration Details - Admin - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Admin</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('registration_admin.list_registrations') }}">Registrations</a></li>
                    <li class="breadcrumb-item active">{{ registration.name }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Registration Details</h1>
                    <p class="text-muted">
                        {% if registration.team_name %}
                        Team Registration: {{ registration.team_name }}
                        {% else %}
                        Player Registration
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('registration_admin.list_registrations') }}" class="btn btn-outline-secondary">
                        <i class="ph ph-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Information -->
        <div class="col-lg-8">
            <!-- Status and Basic Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-info"></i> Registration Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            {% if registration.status.value == 'pending' %}
                            <span class="badge bg-warning">Pending Review</span>
                            {% elif registration.status.value == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif registration.status.value == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                            {% elif registration.status.value == 'waitlisted' %}
                            <span class="badge bg-secondary">Waitlisted</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Payment Status:</strong>
                            {% if registration.payment_status.value == 'paid' %}
                            <span class="badge bg-success"><i class="ph ph-check-circle"></i> Paid</span>
                            {% elif registration.payment_status.value == 'unpaid' %}
                            <span class="badge bg-danger"><i class="ph ph-x-circle"></i> Unpaid</span>
                            {% elif registration.payment_status.value == 'waived' %}
                            <span class="badge bg-secondary">Waived</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Season:</strong> {{ registration.season.name }}
                        </div>
                        <div class="col-md-6">
                            <strong>Registered:</strong> {{ registration.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                    </div>

                    {% if registration.reviewed_at %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Reviewed By:</strong> {{ registration.reviewed_by.name if registration.reviewed_by else 'N/A' }}
                        </div>
                        <div class="col-md-6">
                            <strong>Reviewed At:</strong> {{ registration.reviewed_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-user"></i> Contact Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Name:</strong></div>
                        <div class="col-md-8">{{ registration.name }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Email:</strong></div>
                        <div class="col-md-8"><a href="mailto:{{ registration.email }}">{{ registration.email }}</a></div>
                    </div>
                    {% if registration.phone %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Phone:</strong></div>
                        <div class="col-md-8"><a href="tel:{{ registration.phone }}">{{ registration.phone }}</a></div>
                    </div>
                    {% endif %}
                    {% if registration.date_of_birth %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Date of Birth:</strong></div>
                        <div class="col-md-8">
                            {{ registration.date_of_birth.strftime('%B %d, %Y') }}
                            {% if registration.age %}
                            ({{ registration.age }} years old)
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if registration.gender %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Gender:</strong></div>
                        <div class="col-md-8">{{ registration.gender.title() }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Team Information (if team registration) -->
            {% if registration.team_name %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-users"></i> Team Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Team Name:</strong></div>
                        <div class="col-md-8">{{ registration.team_name }}</div>
                    </div>
                    {% if registration.team_size %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Team Size:</strong></div>
                        <div class="col-md-8">{{ registration.team_size }} players</div>
                    </div>
                    {% endif %}
                    {% if registration.skill_level %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Skill Level:</strong></div>
                        <div class="col-md-8">{{ registration.skill_level.title() }}</div>
                    </div>
                    {% endif %}
                    {% if registration.primary_color or registration.secondary_color or registration.accent_color %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Team Colors:</strong></div>
                        <div class="col-md-8">
                            {% if registration.primary_color %}
                            <span class="badge" style="background-color: {{ registration.primary_color }}; color: white;">Primary</span>
                            {% endif %}
                            {% if registration.secondary_color %}
                            <span class="badge" style="background-color: {{ registration.secondary_color }}; color: white;">Secondary</span>
                            {% endif %}
                            {% if registration.accent_color %}
                            <span class="badge" style="background-color: {{ registration.accent_color }}; color: white;">Accent</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if registration.team_logo_url %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Team Logo:</strong></div>
                        <div class="col-md-8">
                            <img src="{{ registration.team_logo_url }}" alt="Team Logo" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Player Information (if player registration) -->
            {% if not registration.team_name %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-user-circle"></i> Player Information</h5>
                </div>
                <div class="card-body">
                    {% if registration.player_photo_url %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <img src="{{ registration.player_photo_url }}" alt="Player Photo" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>
                    {% endif %}
                    {% if registration.skill_level %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Skill Level:</strong></div>
                        <div class="col-md-8">{{ registration.skill_level.title() }}</div>
                    </div>
                    {% endif %}
                    {% if registration.jersey_size %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Jersey Size:</strong></div>
                        <div class="col-md-8">{{ registration.jersey_size }}</div>
                    </div>
                    {% endif %}
                    {% if registration.jersey_number_preference %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Jersey # Preference:</strong></div>
                        <div class="col-md-8">{{ registration.jersey_number_preference }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Emergency Contact -->
            {% if registration.emergency_contact_name %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-first-aid-kit"></i> Emergency Contact</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Name:</strong></div>
                        <div class="col-md-8">{{ registration.emergency_contact_name }}</div>
                    </div>
                    {% if registration.emergency_contact_phone %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Phone:</strong></div>
                        <div class="col-md-8"><a href="tel:{{ registration.emergency_contact_phone }}">{{ registration.emergency_contact_phone }}</a></div>
                    </div>
                    {% endif %}
                    {% if registration.emergency_contact_relationship %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Relationship:</strong></div>
                        <div class="col-md-8">{{ registration.emergency_contact_relationship }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Medical Information -->
            {% if registration.medical_conditions or registration.allergies %}
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="ph ph-warning"></i> Medical Information</h5>
                </div>
                <div class="card-body">
                    {% if registration.medical_conditions %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Medical Conditions:</strong></div>
                        <div class="col-md-8">{{ registration.medical_conditions }}</div>
                    </div>
                    {% endif %}
                    {% if registration.allergies %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Allergies:</strong></div>
                        <div class="col-md-8">{{ registration.allergies }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Additional Information -->
            {% if registration.preferred_division or registration.notes or registration.special_requirements %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-note"></i> Additional Information</h5>
                </div>
                <div class="card-body">
                    {% if registration.preferred_division %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Preferred Division:</strong></div>
                        <div class="col-md-8">{{ registration.preferred_division }}</div>
                    </div>
                    {% endif %}
                    {% if registration.special_requirements %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Special Requirements:</strong></div>
                        <div class="col-md-8">{{ registration.special_requirements }}</div>
                    </div>
                    {% endif %}
                    {% if registration.notes %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Notes:</strong></div>
                        <div class="col-md-8">{{ registration.notes }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Payment Information -->
            {% if registration.payment_method or registration.payment_transaction_id or registration.payment_notes %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-currency-dollar"></i> Payment Information</h5>
                </div>
                <div class="card-body">
                    {% if registration.payment_method %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Payment Method:</strong></div>
                        <div class="col-md-8">{{ registration.payment_method }}</div>
                    </div>
                    {% endif %}
                    {% if registration.payment_transaction_id %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Transaction ID:</strong></div>
                        <div class="col-md-8"><code>{{ registration.payment_transaction_id }}</code></div>
                    </div>
                    {% endif %}
                    {% if registration.paid_at %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Paid At:</strong></div>
                        <div class="col-md-8">{{ registration.paid_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                    </div>
                    {% endif %}
                    {% if registration.payment_notes %}
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Payment Notes:</strong></div>
                        <div class="col-md-8">
                            <pre style="white-space: pre-wrap;">{{ registration.payment_notes }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Admin Notes -->
            {% if registration.admin_notes or registration.rejection_reason %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-note-pencil"></i> Admin Notes</h5>
                </div>
                <div class="card-body">
                    {% if registration.rejection_reason %}
                    <div class="alert alert-danger">
                        <strong>Rejection Reason:</strong><br>
                        {{ registration.rejection_reason }}
                    </div>
                    {% endif %}
                    {% if registration.admin_notes %}
                    <pre style="white-space: pre-wrap;">{{ registration.admin_notes }}</pre>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Actions -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    {% if registration.status.value == 'pending' %}
                    <!-- Approve -->
                    <form method="POST" action="{{ url_for('registration_admin.approve_registration', registration_id=registration.id) }}" class="mb-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-2">
                            <label class="form-label small">Admin Notes (Optional)</label>
                            <textarea name="admin_notes" class="form-control form-control-sm" rows="2" placeholder="Add any notes..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="ph ph-check-circle"></i> Approve Registration
                        </button>
                    </form>

                    <!-- Reject -->
                    <button class="btn btn-danger w-100 mb-2" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        <i class="ph ph-x-circle"></i> Reject Registration
                    </button>

                    <!-- Waitlist -->
                    <form method="POST" action="{{ url_for('registration_admin.waitlist_registration', registration_id=registration.id) }}" class="mb-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-secondary w-100">
                            <i class="ph ph-clock"></i> Move to Waitlist
                        </button>
                    </form>
                    {% endif %}

                    <!-- Mark as Paid -->
                    {% if registration.payment_status.value != 'paid' %}
                    <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#paymentModal">
                        <i class="ph ph-currency-dollar"></i> Mark as Paid
                    </button>
                    {% endif %}

                    <!-- Add Note -->
                    <button class="btn btn-outline-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#noteModal">
                        <i class="ph ph-note-pencil"></i> Add Admin Note
                    </button>

                    <!-- Delete -->
                    <button class="btn btn-outline-danger w-100" onclick="if(confirm('Are you sure you want to delete this registration? This cannot be undone.')) document.getElementById('deleteForm').submit();">
                        <i class="ph ph-trash"></i> Delete Registration
                    </button>
                    <form id="deleteForm" method="POST" action="{{ url_for('registration_admin.delete_registration', registration_id=registration.id) }}" style="display:none;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    </form>
                </div>
            </div>

            <!-- Waiver Information -->
            {% if registration.waiver %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-file-text"></i> Waiver</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>{{ registration.waiver.title }}</strong>
                        <br><small class="text-muted">Version {{ registration.waiver.version }}</small>
                    </div>
                    {% if registration.waiver_signed %}
                    <div class="alert alert-success mb-0">
                        <i class="ph ph-check-circle"></i> Signed on {{ registration.waiver_signed_at.strftime('%B %d, %Y') if registration.waiver_signed_at else 'N/A' }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registration_admin.reject_registration', registration_id=registration.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Reject Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea name="rejection_reason" class="form-control" rows="3" required placeholder="Explain why this registration is being rejected..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Admin Notes (Optional)</label>
                        <textarea name="admin_notes" class="form-control" rows="2" placeholder="Internal notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="ph ph-x-circle"></i> Reject Registration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registration_admin.mark_paid', registration_id=registration.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Mark as Paid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-select">
                            <option value="">Select method...</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="e-transfer">E-Transfer</option>
                            <option value="paypal">PayPal</option>
                            <option value="stripe">Stripe</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction ID (Optional)</label>
                        <input type="text" name="transaction_id" class="form-control" placeholder="Receipt or transaction number">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Notes (Optional)</label>
                        <textarea name="payment_notes" class="form-control" rows="2" placeholder="Any additional payment details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph ph-check-circle"></i> Mark as Paid
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('registration_admin.add_note', registration_id=registration.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Add Admin Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea name="note" class="form-control" rows="4" required placeholder="Enter your note..."></textarea>
                        <div class="form-text">This will be timestamped and attributed to you.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph ph-note-pencil"></i> Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
