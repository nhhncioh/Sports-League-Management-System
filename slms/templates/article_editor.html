{% extends "base.html" %}
{% block title %}{{ 'Edit Article' if article else 'New Article' }} - Content Management{% endblock %}

{% set can_approve = current_user.has_role('owner', 'admin') %}
{% set can_publish = current_user.has_role('owner', 'admin') %}

{% block extra_css %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
<style>
    .editor-container {
        height: 500px;
    }
    .ql-editor {
        min-height: 450px;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    .workflow-status {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 500;
    }
    .status-draft { background-color: #e9ecef; color: #495057; }
    .status-pending_review { background-color: #fff3cd; color: #856404; }
    .status-approved { background-color: #d1ecf1; color: #0c5460; }
    .status-published { background-color: #d4edda; color: #155724; }
    .status-trashed { background-color: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">{{ 'Edit Article' if article else 'New Article' }}</h1>
            {% if article %}
            <div class="d-flex align-items-center gap-2 mt-2">
                <span class="workflow-status status-{{ article.status.value }}">
                    {{ article.status.value.replace('_', ' ').title() }}
                </span>
                {% if article.published_at %}
                <small class="text-muted">Published {{ article.published_at.strftime('%B %d, %Y') }}</small>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('content_mgmt.articles_list') }}" class="btn btn-outline-secondary">
                <i class="ph ph-arrow-left"></i> Back to Articles
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Editor -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="article-title" class="form-label fw-bold">Title</label>
                        <input type="text" class="form-control form-control-lg" id="article-title"
                               placeholder="Enter article title..."
                               value="{{ article.title if article else '' }}" required>
                        <small class="text-muted">Slug: <span id="article-slug">{{ article.slug if article else '' }}</span></small>
                    </div>

                    <div class="mb-3">
                        <label for="article-excerpt" class="form-label fw-bold">Excerpt</label>
                        <textarea class="form-control" id="article-excerpt" rows="3"
                                  placeholder="Brief summary (optional)">{{ article.excerpt if article else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Content</label>
                        <div id="article-editor" class="editor-container"></div>
                        <textarea id="article-content" style="display:none;">{{ article.content if article else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="change-summary" class="form-label">Change Summary (optional)</label>
                        <input type="text" class="form-control" id="change-summary"
                               placeholder="Describe what you changed...">
                    </div>
                </div>
            </div>

            <!-- Revision History -->
            {% if article %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-clock-counter-clockwise"></i> Revision History</h5>
                </div>
                <div class="card-body">
                    <div id="revision-list" class="list-group list-group-flush">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Loading revisions...</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Publishing Actions -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="ph ph-paper-plane-tilt"></i> Publishing</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="save-draft-btn">
                            <i class="ph ph-floppy-disk"></i> Save Draft
                        </button>
                        {% if article and article.status.value == 'draft' %}
                        <button type="button" class="btn btn-warning" id="submit-review-btn">
                            <i class="ph ph-paper-plane"></i> Submit for Review
                        </button>
                        {% endif %}
                        {% if article and article.status.value == 'pending_review' %}
                        <button type="button" class="btn btn-success" id="approve-btn"
                                {% if not can_approve %}disabled{% endif %}>
                            <i class="ph ph-check-circle"></i> Approve
                        </button>
                        <button type="button" class="btn btn-danger" id="reject-btn"
                                {% if not can_approve %}disabled{% endif %}>
                            <i class="ph ph-x-circle"></i> Reject
                        </button>
                        {% endif %}
                        {% if article and article.status.value in ['approved', 'draft'] %}
                        <button type="button" class="btn btn-primary" id="publish-btn"
                                {% if not can_publish %}disabled{% endif %}>
                            <i class="ph ph-check"></i> Publish Now
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="schedule-btn"
                                {% if not can_publish %}disabled{% endif %}>
                            <i class="ph ph-calendar"></i> Schedule Publish
                        </button>
                        {% endif %}
                        {% if article and article.status.value == 'published' %}
                        <button type="button" class="btn btn-warning" id="unpublish-btn"
                                {% if not can_publish %}disabled{% endif %}>
                            <i class="ph ph-eye-slash"></i> Unpublish
                        </button>
                        {% endif %}
                    </div>

                    {% if article %}
                    <hr>
                    <button type="button" class="btn btn-outline-danger w-100" id="trash-btn">
                        <i class="ph ph-trash"></i> Move to Trash
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Featured Image -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="ph ph-image"></i> Featured Image</h6>
                </div>
                <div class="card-body">
                    <div id="featured-image-preview" class="mb-2">
                        {% if article and article.featured_image_url %}
                        <img src="{{ article.featured_image_url }}" class="img-fluid rounded mb-2" alt="Featured">
                        {% else %}
                        <div class="text-center p-4 bg-light rounded">
                            <i class="ph ph-image" style="font-size: 3rem; color: #ccc;"></i>
                        </div>
                        {% endif %}
                    </div>
                    <input type="text" class="form-control mb-2" id="featured-image-url"
                           placeholder="Image URL"
                           value="{{ article.featured_image_url if article and article.featured_image_url else '' }}">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="browse-assets-btn">
                        <i class="ph ph-folder-open"></i> Browse Assets
                    </button>
                </div>
            </div>

            <!-- Categories & Tags -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="ph ph-tag"></i> Organization</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="categories" class="form-label small">Categories</label>
                        <input type="text" class="form-control form-control-sm" id="categories"
                               placeholder="news, updates, announcements"
                               value="{{ article.categories|join(', ') if article and article.categories else '' }}">
                        <small class="text-muted">Comma-separated</small>
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label small">Tags</label>
                        <input type="text" class="form-control form-control-sm" id="tags"
                               placeholder="season, playoffs, championship"
                               value="{{ article.tags|join(', ') if article and article.tags else '' }}">
                        <small class="text-muted">Comma-separated</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is-featured"
                               {{ 'checked' if article and article.is_featured else '' }}>
                        <label class="form-check-label small" for="is-featured">
                            Featured Article
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is-pinned"
                               {{ 'checked' if article and article.is_pinned else '' }}>
                        <label class="form-check-label small" for="is-pinned">
                            Pin to Top
                        </label>
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="ph ph-magnifying-glass"></i> SEO</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label for="meta-description" class="form-label small">Meta Description</label>
                        <textarea class="form-control form-control-sm" id="meta-description" rows="2"
                                  placeholder="Brief description for search engines">{{ article.meta_description if article else '' }}</textarea>
                    </div>
                    <div>
                        <label for="meta-keywords" class="form-label small">Meta Keywords</label>
                        <input type="text" class="form-control form-control-sm" id="meta-keywords"
                               placeholder="keyword1, keyword2, keyword3"
                               value="{{ article.meta_keywords if article else '' }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Publish Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Publishing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="scheduled-datetime" class="form-label">Publish Date & Time</label>
                <input type="datetime-local" class="form-control" id="scheduled-datetime">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-schedule-btn">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalTitle">Review Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="review-notes" class="form-label">Notes</label>
                <textarea class="form-control" id="review-notes" rows="4"
                          placeholder="Optional notes for the author..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-review-btn">Submit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Rich Text Editor -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
<script>
const articleId = {{ ('"%s"' % article.id) if article else 'null' }};
let quill;
let reviewModal, scheduleModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    quill = new Quill('#article-editor', {
        theme: 'snow',
        placeholder: 'Write your article content here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image', 'video'],
                ['clean']
            ]
        }
    });

    // Load existing content
    const existingContent = document.getElementById('article-content').value;
    if (existingContent) {
        quill.root.innerHTML = existingContent;
    }

    // Auto-generate slug from title
    document.getElementById('article-title').addEventListener('input', function(e) {
        const slug = slugify(e.target.value);
        document.getElementById('article-slug').textContent = slug;
    });

    // Initialize modals
    reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
    scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));

    // Featured image preview
    document.getElementById('featured-image-url').addEventListener('change', function(e) {
        const url = e.target.value;
        const preview = document.getElementById('featured-image-preview');
        if (url) {
            preview.innerHTML = `<img src="${url}" class="img-fluid rounded mb-2" alt="Featured">`;
        } else {
            preview.innerHTML = '<div class="text-center p-4 bg-light rounded"><i class="ph ph-image" style="font-size: 3rem; color: #ccc;"></i></div>';
        }
    });

    // Load revisions if editing
    if (articleId) {
        loadRevisions();
    }

    // Button handlers
    document.getElementById('save-draft-btn')?.addEventListener('click', saveDraft);
    document.getElementById('submit-review-btn')?.addEventListener('click', submitForReview);
    document.getElementById('approve-btn')?.addEventListener('click', () => showReviewModal('approve'));
    document.getElementById('reject-btn')?.addEventListener('click', () => showReviewModal('reject'));
    document.getElementById('publish-btn')?.addEventListener('click', publishNow);
    document.getElementById('schedule-btn')?.addEventListener('click', () => scheduleModal.show());
    document.getElementById('confirm-schedule-btn')?.addEventListener('click', schedulePublish);
    document.getElementById('unpublish-btn')?.addEventListener('click', unpublish);
    document.getElementById('trash-btn')?.addEventListener('click', moveToTrash);
    document.getElementById('browse-assets-btn')?.addEventListener('click', () => {
        window.open('{{ url_for("content_mgmt.assets_manager") }}', '_blank');
    });
});

function slugify(text) {
    return text.toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
}

function getArticleData() {
    return {
        title: document.getElementById('article-title').value.trim(),
        content: quill.root.innerHTML,
        excerpt: document.getElementById('article-excerpt').value.trim(),
        featured_image_url: document.getElementById('featured-image-url').value.trim(),
        categories: document.getElementById('categories').value.split(',').map(c => c.trim()).filter(c => c),
        tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
        is_featured: document.getElementById('is-featured').checked,
        is_pinned: document.getElementById('is-pinned').checked,
        meta_description: document.getElementById('meta-description').value.trim(),
        meta_keywords: document.getElementById('meta-keywords').value.trim(),
        change_summary: document.getElementById('change-summary').value.trim()
    };
}

async function saveDraft() {
    const data = getArticleData();
    if (!data.title || !data.content) {
        alert('Title and content are required');
        return;
    }

    try {
        const url = articleId ? `/content/api/articles/${articleId}` : '/content/api/articles';
        const method = articleId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            if (!articleId) {
                window.location.href = `/content/articles/${result.id}/edit`;
            } else {
                alert('Draft saved successfully');
                document.getElementById('change-summary').value = '';
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (err) {
        alert('Failed to save: ' + err.message);
    }
}

async function submitForReview() {
    if (!articleId) return;

    try {
        const response = await fetch(`/content/api/articles/${articleId}/submit-review`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Article submitted for review');
            location.reload();
        }
    } catch (err) {
        alert('Failed to submit: ' + err.message);
    }
}

function showReviewModal(action) {
    document.getElementById('reviewModalTitle').textContent = action === 'approve' ? 'Approve Article' : 'Reject Article';
    document.getElementById('review-notes').required = action === 'reject';
    document.getElementById('confirm-review-btn').onclick = () => submitReview(action);
    reviewModal.show();
}

async function submitReview(action) {
    if (!articleId) return;

    const notes = document.getElementById('review-notes').value.trim();
    if (action === 'reject' && !notes) {
        alert('Notes are required for rejection');
        return;
    }

    try {
        const response = await fetch(`/content/api/articles/${articleId}/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes })
        });

        if (response.ok) {
            reviewModal.hide();
            alert(`Article ${action}d successfully`);
            location.reload();
        }
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

async function publishNow() {
    if (!articleId) return;

    try {
        const response = await fetch(`/content/api/articles/${articleId}/publish`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Article published successfully');
            location.reload();
        }
    } catch (err) {
        alert('Failed to publish: ' + err.message);
    }
}

async function schedulePublish() {
    if (!articleId) return;

    const datetime = document.getElementById('scheduled-datetime').value;
    if (!datetime) {
        alert('Please select a date and time');
        return;
    }

    try {
        const response = await fetch(`/content/api/articles/${articleId}/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scheduled_at: datetime })
        });

        if (response.ok) {
            scheduleModal.hide();
            alert('Article scheduled for publishing');
            location.reload();
        }
    } catch (err) {
        alert('Failed to schedule: ' + err.message);
    }
}

async function unpublish() {
    if (!articleId || !confirm('Unpublish this article?')) return;

    try {
        const response = await fetch(`/content/api/articles/${articleId}/unpublish`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Article unpublished');
            location.reload();
        }
    } catch (err) {
        alert('Failed to unpublish: ' + err.message);
    }
}

async function moveToTrash() {
    if (!articleId || !confirm('Move this article to trash?')) return;

    try {
        const response = await fetch(`/content/api/articles/${articleId}/trash`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Article moved to trash');
            window.location.href = '{{ url_for("content_mgmt.articles_list") }}';
        }
    } catch (err) {
        alert('Failed to trash: ' + err.message);
    }
}

async function loadRevisions() {
    try {
        const response = await fetch(`/content/api/articles/${articleId}/revisions`);
        const revisions = await response.json();

        const container = document.getElementById('revision-list');
        if (revisions.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-3">No revisions yet</div>';
            return;
        }

        container.innerHTML = revisions.map(r => `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>Revision #${r.revision_number}</strong>
                        ${r.change_summary ? `<br><small class="text-muted">${r.change_summary}</small>` : ''}
                        <br><small class="text-muted">
                            by ${r.edited_by.email} on ${new Date(r.created_at).toLocaleString()}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="restoreRevision('${r.id}')">
                        <i class="ph ph-arrow-counter-clockwise"></i> Restore
                    </button>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Failed to load revisions:', err);
    }
}

async function restoreRevision(revisionId) {
    if (!confirm('Restore this revision? Current content will be saved as a new revision.')) return;

    try {
        const response = await fetch(`/content/api/articles/${articleId}/revisions/${revisionId}/restore`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Revision restored');
            location.reload();
        }
    } catch (err) {
        alert('Failed to restore: ' + err.message);
    }
}
</script>
{% endblock %}
