{% extends "base.html" %}
{% block title %}Score Management - Admin Panel{% endblock %}

{% block extra_css %}
<style>
/* Score Management Page Styles */
.score-management-page .page-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border-radius: 1rem;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.12);
}

.score-management-page .page-header .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.score-management-page .page-header .stat-item {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
}

.score-management-page .page-header .stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.score-management-page .page-header .stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-top: 0.5rem;
}

/* Filter Controls */
.filter-controls {
    background: rgba(248, 250, 252, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226, 232, 240, 0.8);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
}

/* Match Cards */
.match-card {
    background: white;
    border-radius: 1rem;
    border: none;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 1.5rem;
    overflow: hidden;
    position: relative;
}

.match-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(15, 23, 42, 0.15);
}

/* Match Status Indicators */
.match-card.scheduled {
    border-left: 4px solid #f59e0b;
}

.match-card.live {
    border-left: 4px solid #ef4444;
    animation: pulse-glow 2s infinite;
}

.match-card.completed {
    border-left: 4px solid #10b981;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15); }
    50% { box-shadow: 0 8px 32px rgba(239, 68, 68, 0.25); }
}

/* Match Header */
.match-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.match-info h6 {
    margin: 0;
    font-weight: 600;
    color: #334155;
    font-size: 1rem;
}

.match-info .match-details {
    color: #64748b;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Status Badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: none;
}

.status-scheduled {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #92400e;
}

.status-live {
    background: linear-gradient(135deg, #f87171, #ef4444);
    color: white;
    animation: pulse-badge 1.5s infinite;
}

.status-completed {
    background: linear-gradient(135deg, #34d399, #10b981);
    color: #065f46;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.9; transform: scale(1.05); }
}

.live-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Match Body */
.match-body {
    padding: 2rem;
}

/* Team Section */
.team-matchup {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2rem;
}

.team-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.team-info.away {
    flex-direction: row-reverse;
    text-align: right;
}

.team-logo {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #f1f5f9;
    background: #f8fafc;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    transition: all 0.2s ease;
}

.team-logo:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
}

.team-details h4 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
}

.team-details .team-badge {
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
    color: #475569;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.5rem;
    display: inline-block;
}

/* Score Section */
.score-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.score-display {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.score-input {
    width: 4rem;
    height: 4rem;
    font-size: 1.875rem;
    font-weight: 700;
    text-align: center;
    border: 2px solid #e2e8f0;
    border-radius: 0.75rem;
    background: white;
    color: #1e293b;
    transition: all 0.2s ease;
}

.score-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    transform: scale(1.05);
    outline: none;
}

.score-display-readonly {
    font-size: 3rem;
    font-weight: 800;
    color: #10b981;
    text-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
}

.vs-separator {
    font-size: 1.25rem;
    font-weight: 600;
    color: #64748b;
    padding: 0 1rem;
}

/* Quick Actions */
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin: 1.5rem 0;
}

.quick-score-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    color: #64748b;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-score-btn:hover {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Match Actions */
.match-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(226, 232, 240, 0.8);
}

.btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* Completed Match Display */
.completed-match {
    text-align: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border-radius: 0.75rem;
    border: 1px solid #a7f3d0;
    margin-top: 1rem;
}

.completed-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #10b981;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 600;
}

/* Sidebar */
.sidebar-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(226, 232, 240, 0.8);
}

.recent-result {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.recent-result:last-child {
    border-bottom: none;
}

.result-teams {
    font-weight: 500;
    color: #1e293b;
}

.result-date {
    color: #64748b;
    font-size: 0.875rem;
}

.result-score {
    font-weight: 700;
    color: #10b981;
    font-size: 1.125rem;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f1f5f9;
}

.stat-summary-item {
    text-align: center;
}

.stat-summary-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.stat-summary-value.completed { color: #10b981; }
.stat-summary-value.live { color: #ef4444; }
.stat-summary-value.scheduled { color: #f59e0b; }

.stat-summary-label {
    color: #64748b;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .team-matchup {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        text-align: center;
    }

    .team-info.away {
        flex-direction: row;
        text-align: center;
    }

    .match-actions {
        flex-direction: column;
    }

    .quick-actions {
        justify-content: center;
    }

    .score-management-page .page-header .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .match-body {
        padding: 1rem;
    }

    .team-logo {
        width: 48px;
        height: 48px;
    }

    .score-input {
        width: 3rem;
        height: 3rem;
        font-size: 1.5rem;
    }

    .score-display-readonly {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 score-management-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-0">
            <div>
                <h1 class="h2 mb-2 d-flex align-items-center gap-2">
                    <i class="ph ph-target"></i>
                    Score Management
                </h1>
                <p class="mb-0 opacity-90">Manage match scores, track live games, and monitor results across all leagues</p>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ matches|length if matches else 0 }}</div>
                <div class="stat-label">Total Matches</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ live_matches or 0 }}</div>
                <div class="stat-label">Live Now</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ completed_today or 0 }}</div>
                <div class="stat-label">Completed Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ scheduled_today or 0 }}</div>
                <div class="stat-label">Scheduled Today</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-controls">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">League</label>
                <select class="form-select" name="league_filter" onchange="this.form.submit()">
                    <option value="">All Leagues</option>
                    {% for league in leagues %}
                    <option value="{{ league[0] }}" {% if league[0]|string == request.args.get('league_filter', '') %}selected{% endif %}>
                        {{ league[1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status_filter" onchange="this.form.submit()">
                    <option value="">All Matches</option>
                    <option value="scheduled" {% if request.args.get('status_filter') == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="live" {% if request.args.get('status_filter') == 'live' %}selected{% endif %}>Live</option>
                    <option value="completed" {% if request.args.get('status_filter') == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" name="date_filter" value="{{ request.args.get('date_filter', '') }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-3">
                <a href="{{ url_for('admin.manage_scores') }}" class="btn btn-outline-secondary w-100">
                    <i class="ph ph-arrow-clockwise me-2"></i>Clear Filters
                </a>
            </div>
        </form>
    </div>

    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-lg-8">
            {% if matches %}
                {% for match in matches %}
                <div class="match-card {{ match.status or 'scheduled' }}">
                    <!-- Match Header -->
                    <div class="match-header">
                        <div class="match-info">
                            <h6><i class="ph ph-trophy me-2"></i>{{ match.league_name or 'League' }}</h6>
                            <div class="match-details">
                                <span><i class="ph ph-calendar me-1"></i>{{ match.utc_date }}</span>
                                {% if match.match_time %}
                                <span><i class="ph ph-clock me-1"></i>{{ match.match_time }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            {% if match.status == 'live' %}
                            <span class="status-badge status-live">
                                <span class="live-indicator"></span>
                                LIVE
                            </span>
                            {% else %}
                            <span class="status-badge status-{{ match.status or 'scheduled' }}">
                                {{ (match.status or 'scheduled')|title }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Match Body -->
                    <div class="match-body">
                        {% if match.status == 'completed' %}
                        <!-- Completed Match Display -->
                        <div class="team-matchup">
                            <div class="team-info">
                                <img src="{{ match.home_crest or '/static/images/default-team-logo.png' }}"
                                     alt="{{ match.home_team }}" class="team-logo"
                                     onerror="this.src='/static/images/default-team-logo.png'">
                                <div class="team-details">
                                    <h4>{{ match.home_team }}</h4>
                                    <span class="team-badge">Home</span>
                                </div>
                            </div>

                            <div class="score-section">
                                <div class="score-display">
                                    <div class="score-display-readonly">{{ match.home_score if match.home_score is not none else '-' }}</div>
                                    <div class="vs-separator">:</div>
                                    <div class="score-display-readonly">{{ match.away_score if match.away_score is not none else '-' }}</div>
                                </div>
                            </div>

                            <div class="team-info away">
                                <img src="{{ match.away_crest or '/static/images/default-team-logo.png' }}"
                                     alt="{{ match.away_team }}" class="team-logo"
                                     onerror="this.src='/static/images/default-team-logo.png'">
                                <div class="team-details">
                                    <h4>{{ match.away_team }}</h4>
                                    <span class="team-badge">Away</span>
                                </div>
                            </div>
                        </div>

                        <div class="completed-match">
                            <div class="completed-badge">
                                <i class="ph ph-check-circle"></i>
                                Match Completed
                            </div>
                            <div class="mt-3">
                                <a href="{{ url_for('live_scoring.game_console', game_id=match.match_id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="ph ph-broadcast"></i> View Details & Stats
                                </a>
                            </div>
                        </div>

                        {% else %}
                        <!-- Active Match Form -->
                        <form method="post" action="{{ url_for('admin.manage_scores') }}">
                            <input type="hidden" name="action" value="update_score">
                            <input type="hidden" name="match_id" value="{{ match.match_id }}">

                            <div class="team-matchup">
                                <div class="team-info">
                                    <img src="{{ match.home_crest or '/static/images/default-team-logo.png' }}"
                                         alt="{{ match.home_team }}" class="team-logo"
                                         onerror="this.src='/static/images/default-team-logo.png'">
                                    <div class="team-details">
                                        <h4>{{ match.home_team }}</h4>
                                        <span class="team-badge">Home</span>
                                    </div>
                                </div>

                                <div class="score-section">
                                    <div class="score-display">
                                        <input type="number" class="score-input" name="home_score"
                                               value="{{ match.home_score if match.home_score is not none else '' }}"
                                               min="0" max="20" placeholder="0">
                                        <div class="vs-separator">VS</div>
                                        <input type="number" class="score-input" name="away_score"
                                               value="{{ match.away_score if match.away_score is not none else '' }}"
                                               min="0" max="20" placeholder="0">
                                    </div>
                                </div>

                                <div class="team-info away">
                                    <img src="{{ match.away_crest or '/static/images/default-team-logo.png' }}"
                                         alt="{{ match.away_team }}" class="team-logo"
                                         onerror="this.src='/static/images/default-team-logo.png'">
                                    <div class="team-details">
                                        <h4>{{ match.away_team }}</h4>
                                        <span class="team-badge">Away</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Score Options -->
                            <div class="quick-actions">
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '1', '0')">1-0</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '0', '1')">0-1</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '1', '1')">1-1</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '2', '1')">2-1</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '0', '0')">0-0</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '3', '1')">3-1</button>
                                <button type="button" class="quick-score-btn" onclick="setQuickScore(this, '2', '2')">2-2</button>
                            </div>

                            <!-- Match Actions -->
                            <div class="match-actions">
                                <a href="{{ url_for('live_scoring.game_console', game_id=match.match_id) }}" class="btn-action btn-info" target="_blank">
                                    <i class="ph ph-broadcast"></i>Live Console
                                </a>

                                {% if match.status != 'live' %}
                                <button type="submit" name="set_status" value="live" class="btn-action btn-warning">
                                    <i class="ph ph-play"></i>Start Match
                                </button>
                                {% endif %}

                                <button type="submit" class="btn-action btn-primary">
                                    <i class="ph ph-floppy-disk"></i>Save Score
                                </button>

                                <button type="submit" name="set_status" value="completed" class="btn-action btn-success">
                                    <i class="ph ph-check-circle"></i>Complete Match
                                </button>

                                <button type="submit" name="set_status" value="postponed" class="btn-action btn-secondary">
                                    <i class="ph ph-pause"></i>Postpone
                                </button>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="ph ph-calendar-x display-1 text-muted mb-4"></i>
                    <h4 class="text-muted">No Matches Found</h4>
                    <p class="text-muted">Create some matches first to manage scores</p>
                    <a href="{{ url_for('admin.manage_matches') }}" class="btn btn-primary btn-lg">
                        <i class="ph ph-plus me-2"></i>Create Matches
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sidebar-card">
                <h5 class="mb-3 d-flex align-items-center gap-2">
                    <i class="ph ph-clock-countdown"></i>
                    Recent Results
                </h5>

                {% if recent_results %}
                    {% for result in recent_results[:8] %}
                    <div class="recent-result">
                        <div>
                            <div class="result-teams">{{ result.home_team }} vs {{ result.away_team }}</div>
                            <div class="result-date">{{ result.utc_date }}</div>
                        </div>
                        <div class="result-score">{{ result.home_score }}-{{ result.away_score }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="ph ph-trophy" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-2 mb-0">No recent results</p>
                    </div>
                {% endif %}

                <div class="stats-summary">
                    <div class="stat-summary-item">
                        <div class="stat-summary-value completed">{{ completed_today or 0 }}</div>
                        <div class="stat-summary-label">Completed</div>
                    </div>
                    <div class="stat-summary-item">
                        <div class="stat-summary-value live">{{ live_matches or 0 }}</div>
                        <div class="stat-summary-label">Live</div>
                    </div>
                    <div class="stat-summary-item">
                        <div class="stat-summary-value scheduled">{{ scheduled_today or 0 }}</div>
                        <div class="stat-summary-label">Scheduled</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setQuickScore(button, homeScore, awayScore) {
    const form = button.closest('form');
    form.querySelector('input[name="home_score"]').value = homeScore;
    form.querySelector('input[name="away_score"]').value = awayScore;

    // Visual feedback
    button.style.background = '#28a745';
    button.style.color = 'white';
    button.style.transform = 'scale(1.1)';

    setTimeout(() => {
        button.style.background = '';
        button.style.color = '';
        button.style.transform = '';
    }, 500);
}
</script>
{% endblock %}