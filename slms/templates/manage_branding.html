{% extends "base.html" %}
{% block title %}Branding & Landing Page - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Organization Branding</h1>
            <p class="text-muted mb-0">Customize your organization's landing page, hero section, and brand identity</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('public.landing') }}" target="_blank" class="btn btn-outline-primary">
                <i class="ph ph-eye"></i> Preview
            </a>
            <button type="button" class="btn btn-success" onclick="saveBranding()">
                <i class="ph ph-floppy-disk"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#hero-tab">
                <i class="ph ph-image me-2"></i>Hero Section
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#modules-tab">
                <i class="ph ph-squares-four me-2"></i>Page Modules
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#branding-tab">
                <i class="ph ph-palette me-2"></i>Brand Colors
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#assets-tab">
                <i class="ph ph-image me-2"></i>Brand Assets
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#domain-tab">
                <i class="ph ph-globe me-2"></i>Custom Domain
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Hero Section Tab -->
        <div class="tab-pane fade show active" id="hero-tab">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="ph ph-image me-2"></i>Hero Configuration</h5>
                        </div>
                        <div class="card-body">
                            <form id="heroForm">
                                <div class="mb-3">
                                    <label class="form-label">Hero Title</label>
                                    <input type="text" class="form-control" id="hero_title"
                                           placeholder="Welcome to {{ g.org.name if g.org else 'Your League' }}"
                                           value="{{ hero.title if hero else '' }}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Hero Subtitle</label>
                                    <textarea class="form-control" id="hero_subtitle" rows="3"
                                              placeholder="Experience world-class sports management...">{{ hero.subtitle if hero else '' }}</textarea>
                                </div>

                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Gradient Start Color</label>
                                        <input type="color" class="form-control form-control-color" id="hero_gradient_start"
                                               value="{{ hero.gradient_start if hero and hero.gradient_start else '#667eea' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Gradient End Color</label>
                                        <input type="color" class="form-control form-control-color" id="hero_gradient_end"
                                               value="{{ hero.gradient_end if hero and hero.gradient_end else '#764ba2' }}">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Background Image URL</label>
                                    <input type="url" class="form-control" id="hero_bg_image"
                                           placeholder="https://example.com/hero-bg.jpg"
                                           value="{{ hero.background_image if hero and hero.background_image else '' }}">
                                    <small class="text-muted">Optional: Will blend with gradient</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Hero Image URL</label>
                                    <input type="url" class="form-control" id="hero_image"
                                           placeholder="https://example.com/hero-image.png"
                                           value="{{ hero.hero_image if hero and hero.hero_image else '' }}">
                                    <small class="text-muted">Optional: Displays on right side</small>
                                </div>

                                <hr class="my-4">

                                <h6 class="mb-3">Call-to-Action Buttons</h6>

                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Primary CTA Text</label>
                                        <input type="text" class="form-control" id="hero_primary_cta_text"
                                               placeholder="View Standings"
                                               value="{{ hero.primary_cta_text if hero and hero.primary_cta_text else 'View Standings' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Primary CTA URL</label>
                                        <input type="text" class="form-control" id="hero_primary_cta_url"
                                               placeholder="/standings"
                                               value="{{ hero.primary_cta_url if hero and hero.primary_cta_url else '/standings' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Primary CTA Icon</label>
                                        <input type="text" class="form-control" id="hero_primary_cta_icon"
                                               placeholder="trophy"
                                               value="{{ hero.primary_cta_icon if hero and hero.primary_cta_icon else 'trophy' }}">
                                    </div>
                                </div>

                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Secondary CTA Text</label>
                                        <input type="text" class="form-control" id="hero_secondary_cta_text"
                                               placeholder="Stat Leaders"
                                               value="{{ hero.secondary_cta_text if hero and hero.secondary_cta_text else 'Stat Leaders' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Secondary CTA URL</label>
                                        <input type="text" class="form-control" id="hero_secondary_cta_url"
                                               placeholder="/leaderboards"
                                               value="{{ hero.secondary_cta_url if hero and hero.secondary_cta_url else '/leaderboards' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Secondary CTA Icon</label>
                                        <input type="text" class="form-control" id="hero_secondary_cta_icon"
                                               placeholder="chart-line"
                                               value="{{ hero.secondary_cta_icon if hero and hero.secondary_cta_icon else 'chart-line' }}">
                                    </div>
                                </div>

                                <hr class="my-4">

                                <h6 class="mb-3">Hero Features (Max 3)</h6>
                                <div id="heroFeatures">
                                    {% set features = hero.features if hero and hero.features else ['Real-time Updates', 'Complete Statistics', 'Fan Engagement'] %}
                                    {% for feature in features[:3] %}
                                        <div class="input-group mb-2">
                                            <span class="input-group-text"><i class="ph ph-check-circle"></i></span>
                                            <input type="text" class="form-control hero-feature" value="{{ feature }}">
                                        </div>
                                    {% endfor %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="ph ph-lightbulb me-2"></i>Tips</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>Hero Section:</strong> This is the first thing visitors see. Make it compelling!
                            </div>
                            <ul class="small">
                                <li class="mb-2">Keep title concise and impactful (under 50 characters)</li>
                                <li class="mb-2">Subtitle should explain your value proposition</li>
                                <li class="mb-2">Use high-contrast gradient colors for readability</li>
                                <li class="mb-2">CTAs should be action-oriented ("View", "Explore", "Join")</li>
                                <li class="mb-2">Hero image should be 800x600px or larger</li>
                                <li class="mb-2">Icons use Phosphor icon names (see <a href="https://phosphoricons.com" target="_blank">phosphoricons.com</a>)</li>
                            </ul>

                            <hr>

                            <h6 class="mb-3">Preview</h6>
                            <div class="hero-preview p-3 rounded" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 0.85rem;">
                                <strong class="d-block mb-2" id="preview_title">Your Title Here</strong>
                                <p class="mb-2 opacity-75" id="preview_subtitle">Your subtitle...</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-white text-dark" id="preview_cta1">Primary CTA</span>
                                    <span class="badge bg-light text-dark" id="preview_cta2">Secondary CTA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Modules Tab -->
        <div class="tab-pane fade" id="modules-tab">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="ph ph-squares-four me-2"></i>Landing Page Modules</h5>
                    <button class="btn btn-sm btn-primary" onclick="addModule()">
                        <i class="ph ph-plus"></i> Add Module
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted">Drag to reorder modules. They will appear in this order on your landing page.</p>

                    <div id="modulesList" class="vstack gap-3">
                        <!-- Modules will be dynamically added here -->
                        <div class="alert alert-info">
                            <i class="ph ph-info me-2"></i>
                            Click "Add Module" to start building your landing page sections.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branding Tab -->
        <div class="tab-pane fade" id="branding-tab">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="ph ph-palette me-2"></i>Brand Colors</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Primary Color</label>
                                    <input type="color" class="form-control form-control-color w-100" id="brand_primary" value="#667eea">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Secondary Color</label>
                                    <input type="color" class="form-control form-control-color w-100" id="brand_secondary" value="#6c757d">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Accent Color</label>
                                    <input type="color" class="form-control form-control-color w-100" id="brand_accent" value="#f97316">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Background Color</label>
                                    <input type="color" class="form-control form-control-color w-100" id="brand_background" value="#f5f6fa">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Brand Assets Tab -->
        <div class="tab-pane fade" id="assets-tab">
            <div class="row g-4">
                <div class="col-lg-12">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="ph ph-image me-2"></i>Brand Assets</h5>
                        </div>
                        <div class="card-body">
                            <!-- Organization Logo -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Organization Logo</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <div class="upload-zone p-4 border rounded text-center" style="cursor: pointer; background: #f8f9fa;" onclick="document.getElementById('logoFileInput').click()">
                                            <input type="file" id="logoFileInput" accept="image/*" style="display:none;" onchange="handleLogoUpload(this, 'brand_logo')">
                                            <i class="ph ph-cloud-arrow-up fs-1 text-primary mb-2"></i>
                                            <p class="mb-1 fw-semibold">Click to upload logo</p>
                                            <small class="text-muted">PNG, JPG, SVG up to 5MB</small>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Or enter URL:</small>
                                            <input type="url" class="form-control form-control-sm mt-1" id="brand_logo"
                                                   placeholder="https://example.com/logo.png"
                                                   value="{{ g.org.logo_url if g.org and g.org.logo_url else '' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border rounded p-3 text-center" style="background: #fff;">
                                            <small class="text-muted d-block mb-2">Preview</small>
                                            <img id="logo_preview" src="{{ g.org.logo_url if g.org and g.org.logo_url else '' }}"
                                                 style="max-width: 100%; max-height: 120px; {{ 'display: none;' if not (g.org and g.org.logo_url) else '' }}" alt="Logo preview">
                                            <div id="logo_preview_placeholder" style="{{ 'display: none;' if (g.org and g.org.logo_url) else '' }}">
                                                <i class="ph ph-image fs-1 text-muted"></i>
                                                <p class="small text-muted mb-0">No logo</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Favicon -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Favicon</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <div class="upload-zone p-4 border rounded text-center" style="cursor: pointer; background: #f8f9fa;" onclick="document.getElementById('faviconFileInput').click()">
                                            <input type="file" id="faviconFileInput" accept="image/*,.ico" style="display:none;" onchange="handleLogoUpload(this, 'brand_favicon')">
                                            <i class="ph ph-cloud-arrow-up fs-1 text-primary mb-2"></i>
                                            <p class="mb-1 fw-semibold">Click to upload favicon</p>
                                            <small class="text-muted">ICO, PNG (16x16 or 32x32 recommended)</small>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Or enter URL:</small>
                                            <input type="url" class="form-control form-control-sm mt-1" id="brand_favicon"
                                                   placeholder="https://example.com/favicon.ico"
                                                   value="{{ g.org.favicon_url if g.org and g.org.favicon_url else '' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border rounded p-3 text-center" style="background: #fff;">
                                            <small class="text-muted d-block mb-2">Preview</small>
                                            <img id="favicon_preview" src="{{ g.org.favicon_url if g.org and g.org.favicon_url else '' }}"
                                                 style="max-width: 48px; max-height: 48px; {{ 'display: none;' if not (g.org and g.org.favicon_url) else '' }}" alt="Favicon preview">
                                            <div id="favicon_preview_placeholder" style="{{ 'display: none;' if (g.org and g.org.favicon_url) else '' }}">
                                                <i class="ph ph-image fs-3 text-muted"></i>
                                                <p class="small text-muted mb-0">No favicon</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Banner Image -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Banner Image</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <div class="upload-zone p-4 border rounded text-center" style="cursor: pointer; background: #f8f9fa;" onclick="document.getElementById('bannerFileInput').click()">
                                            <input type="file" id="bannerFileInput" accept="image/*" style="display:none;" onchange="handleLogoUpload(this, 'brand_banner')">
                                            <i class="ph ph-cloud-arrow-up fs-1 text-primary mb-2"></i>
                                            <p class="mb-1 fw-semibold">Click to upload banner</p>
                                            <small class="text-muted">PNG, JPG up to 5MB (1920x400 recommended)</small>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Or enter URL:</small>
                                            <input type="url" class="form-control form-control-sm mt-1" id="brand_banner"
                                                   placeholder="https://example.com/banner.jpg"
                                                   value="{{ g.org.banner_image_url if g.org and g.org.banner_image_url else '' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border rounded p-3 text-center" style="background: #fff;">
                                            <small class="text-muted d-block mb-2">Preview</small>
                                            <img id="banner_preview" src="{{ g.org.banner_image_url if g.org and g.org.banner_image_url else '' }}"
                                                 style="max-width: 100%; max-height: 80px; {{ 'display: none;' if not (g.org and g.org.banner_image_url) else '' }}" alt="Banner preview">
                                            <div id="banner_preview_placeholder" style="{{ 'display: none;' if (g.org and g.org.banner_image_url) else '' }}">
                                                <i class="ph ph-image fs-1 text-muted"></i>
                                                <p class="small text-muted mb-0">No banner</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Domain Tab -->
        <div class="tab-pane fade" id="domain-tab">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="ph ph-globe me-2"></i>Custom Domain Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="ph ph-info me-2"></i>
                        <strong>Custom Domain:</strong> Point your domain to our servers to use your own branded URL.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Subdomain</label>
                        <input type="text" class="form-control" value="{{ g.org.slug if g.org else '' }}.sportslms.com" disabled>
                        <small class="text-muted">This is your default subdomain</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Custom Domain</label>
                        <input type="text" class="form-control" id="custom_domain"
                               placeholder="sports.yourorg.com"
                               value="{{ g.org.custom_domain if g.org and g.org.custom_domain else '' }}">
                        <small class="text-muted">Enter your custom domain (e.g., sports.yourorg.com)</small>
                    </div>

                    <div class="alert alert-warning">
                        <strong>DNS Configuration Required:</strong>
                        <p class="mb-2">Point your domain's CNAME record to:</p>
                        <code>{{ request.host }}</code>
                        <p class="mt-2 mb-0">Contact support if you need help setting this up.</p>
                    </div>

                    <button class="btn btn-primary" onclick="verifyDomain()">
                        <i class="ph ph-check-circle"></i> Verify Domain
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle file upload
async function handleLogoUpload(input, targetInputId) {
    const file = input.files[0];
    if (!file) return;

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        input.value = '';
        return;
    }

    // Show loading indicator
    const formData = new FormData();
    formData.append('file', file);
    formData.append('category', 'branding');

    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Upload failed');
        }

        const data = await response.json();

        if (data.success) {
            // Update the URL input field
            document.getElementById(targetInputId).value = data.url;

            // Update preview
            const previewId = targetInputId.replace('brand_', '') + '_preview';
            const placeholderId = targetInputId.replace('brand_', '') + '_preview_placeholder';

            const previewImg = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);

            previewImg.src = data.url;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';

            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <i class="ph ph-check-circle me-2"></i>File uploaded successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            input.parentElement.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        alert('Error uploading file: ' + error.message);
        input.value = '';
    }
}

// Update preview when URL input changes
['brand_logo', 'brand_favicon', 'brand_banner'].forEach(id => {
    const input = document.getElementById(id);
    if (input) {
        input.addEventListener('input', function() {
            const previewId = id.replace('brand_', '') + '_preview';
            const placeholderId = id.replace('brand_', '') + '_preview_placeholder';

            const previewImg = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);

            if (this.value) {
                previewImg.src = this.value;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        });
    }
});

// Preview updates
function updatePreview() {
    document.getElementById('preview_title').textContent =
        document.getElementById('hero_title').value || 'Your Title Here';
    document.getElementById('preview_subtitle').textContent =
        document.getElementById('hero_subtitle').value || 'Your subtitle...';
    document.getElementById('preview_cta1').textContent =
        document.getElementById('hero_primary_cta_text').value || 'Primary CTA';
    document.getElementById('preview_cta2').textContent =
        document.getElementById('hero_secondary_cta_text').value || 'Secondary CTA';

    const gradStart = document.getElementById('hero_gradient_start').value;
    const gradEnd = document.getElementById('hero_gradient_end').value;
    document.querySelector('.hero-preview').style.background =
        `linear-gradient(135deg, ${gradStart}, ${gradEnd})`;
}

// Add event listeners for preview
['hero_title', 'hero_subtitle', 'hero_primary_cta_text', 'hero_secondary_cta_text',
 'hero_gradient_start', 'hero_gradient_end'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', updatePreview);
});

function saveBranding() {
    const features = Array.from(document.querySelectorAll('.hero-feature')).map(input => input.value);

    const data = {
        hero: {
            title: document.getElementById('hero_title').value,
            subtitle: document.getElementById('hero_subtitle').value,
            gradient_start: document.getElementById('hero_gradient_start').value,
            gradient_end: document.getElementById('hero_gradient_end').value,
            background_image: document.getElementById('hero_bg_image').value,
            hero_image: document.getElementById('hero_image').value,
            primary_cta_text: document.getElementById('hero_primary_cta_text').value,
            primary_cta_url: document.getElementById('hero_primary_cta_url').value,
            primary_cta_icon: document.getElementById('hero_primary_cta_icon').value,
            secondary_cta_text: document.getElementById('hero_secondary_cta_text').value,
            secondary_cta_url: document.getElementById('hero_secondary_cta_url').value,
            secondary_cta_icon: document.getElementById('hero_secondary_cta_icon').value,
            features: features
        },
        branding: {
            primary: document.getElementById('brand_primary').value,
            secondary: document.getElementById('brand_secondary').value,
            accent: document.getElementById('brand_accent').value,
            background: document.getElementById('brand_background').value,
            logo: document.getElementById('brand_logo').value,
            favicon: document.getElementById('brand_favicon').value,
            banner: document.getElementById('brand_banner').value
        },
        custom_domain: document.getElementById('custom_domain').value
    };

    // Save to backend
    fetch('/admin/api/branding/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Branding saved successfully!');
        } else {
            alert('Error saving branding: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error saving branding');
        console.error(error);
    });
}

function verifyDomain() {
    const domain = document.getElementById('custom_domain').value;
    alert('Domain verification feature coming soon! Domain: ' + domain);
}

function addModule() {
    alert('Module builder coming soon! You can add features, testimonials, CTA banners, and more.');
}

// Initialize
updatePreview();
</script>
{% endblock %}
