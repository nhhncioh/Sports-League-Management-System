{% extends "base.html" %}
{% block title %}League Rules Management{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Header -->
    <div class="col-12 mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="mb-0">
          <i class="ph ph-scale me-2"></i>League Rules Management
        </h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Admin</a></li>
            <li class="breadcrumb-item active">League Rules</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Rules Configuration Panel -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">
            <i class="ph ph-gear me-2"></i>Configure League Rules
          </h5>
        </div>
        <div class="card-body">
          <form id="rulesForm" method="POST" action="{{ url_for('admin.manage_league_rules') }}">
            <input type="hidden" name="action" value="save_rules">

            <!-- League Selection -->
            <div class="row mb-4">
              <div class="col-md-12">
                <label for="league_id" class="form-label">
                  <i class="ph ph-trophy me-1"></i>Select League <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="league_id" name="league_id" required onchange="loadLeagueRules()">
                  <option value="">Choose a league...</option>
                  {% for league in leagues %}
                    <option value="{{ league.id }}" data-sport="{{ league.sport }}">{{ league.name }}</option>
                  {% endfor %}
                </select>
                <div class="mt-2">
                  <div class="alert alert-info d-none" id="sportDefaultsInfo">
                    <i class="ph ph-info me-2"></i>
                    <strong><span id="sportName"></span> defaults:</strong>
                    <span id="sportDefaults"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scoring Rules -->
            <div class="card border-0 bg-light mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="ph ph-target me-2"></i>Scoring Rules
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="points_win" class="form-label">Points for Win</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ph ph-trophy"></i></span>
                      <input type="number" class="form-control" id="points_win" name="points_win" value="3" min="0" max="10">
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="points_draw" class="form-label">Points for Draw</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ph ph-handshake"></i></span>
                      <input type="number" class="form-control" id="points_draw" name="points_draw" value="1" min="0" max="10">
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="points_loss" class="form-label">Points for Loss</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ph ph-x"></i></span>
                      <input type="number" class="form-control" id="points_loss" name="points_loss" value="0" min="0" max="10">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Game Rules -->
            <div class="card border-0 bg-light mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="ph ph-soccer-ball me-2"></i>Game Rules
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="substitution_limit" class="form-label">Maximum Substitutions</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ph ph-arrow-u-up-right"></i></span>
                      <input type="number" class="form-control" id="substitution_limit" name="substitution_limit" placeholder="e.g., 5" min="0" max="15">
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="foreign_player_limit" class="form-label">Foreign Player Limit</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ph ph-globe"></i></span>
                      <input type="number" class="form-control" id="foreign_player_limit" name="foreign_player_limit" placeholder="e.g., 3" min="0" max="20">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tiebreaker Rules -->
            <div class="card border-0 bg-light mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="ph ph-ranking me-2"></i>Tiebreaker Rules
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="tiebreakers" class="form-label">Tiebreaker Priority</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="ph ph-list-numbers"></i></span>
                    <input type="text" class="form-control" id="tiebreakers" name="tiebreakers" placeholder="e.g., GD,GF,H2H">
                  </div>
                  <div class="form-text">
                    <small>Common options: GD (Goal Difference), GF (Goals For), H2H (Head-to-Head), etc.</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Fields Section -->
            <div class="card border-0 bg-light mb-4" id="customFieldsSection">
              <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="ph ph-plus-square me-2"></i>Custom Rules
                </h6>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCustomFieldModal">
                  <i class="ph ph-plus me-1"></i>Add Field
                </button>
              </div>
              <div class="card-body" id="customFieldsContainer">
                <div class="text-muted text-center py-3" id="noCustomFields">
                  <i class="ph ph-plus-circle fs-1 mb-2 d-block"></i>
                  No custom fields yet. Click "Add Field" to create custom rules for this league.
                </div>
              </div>
            </div>

            <!-- Notes Section -->
            <div class="card border-0 bg-light mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="ph ph-note me-2"></i>Additional Notes
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="notes" class="form-label">League-specific Notes</label>
                  <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional rules, regulations, or notes for this league..."></textarea>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="ph ph-arrow-counter-clockwise me-1"></i>Reset
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="ph ph-floppy-disk me-1"></i>Save Rules
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Existing Rules Panel -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">
            <i class="ph ph-list me-2"></i>Existing League Rules
          </h5>
        </div>
        <div class="card-body p-0">
          {% if rules %}
            <div class="list-group list-group-flush">
              {% for rule in rules %}
                <div class="list-group-item list-group-item-action" onclick="loadSpecificRules({{ rule[0] }})">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ rule[1] }}</h6>
                    <small class="text-success">
                      <i class="ph ph-check-circle"></i>
                    </small>
                  </div>
                  <p class="mb-1">
                    <span class="badge bg-primary me-1">W: {{ rule[2] }}</span>
                    <span class="badge bg-warning me-1">D: {{ rule[3] }}</span>
                    <span class="badge bg-danger me-1">L: {{ rule[4] }}</span>
                  </p>
                  <div class="d-flex justify-content-between">
                    <small class="text-muted">
                      {% if rule[5] %}Tiebreakers: {{ rule[5] }}{% endif %}
                    </small>
                    {% if custom_fields_by_league.get(rule[0]) %}
                      <small class="text-info">
                        <i class="ph ph-gear"></i>{{ custom_fields_by_league[rule[0]]|length }} custom
                      </small>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-4 text-muted">
              <i class="ph ph-empty fs-1 mb-2 d-block"></i>
              <p>No league rules configured yet.</p>
              <p><small>Configure rules for your first league to get started.</small></p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Stats Card -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="d-flex flex-column">
                <span class="fs-2 text-primary">{{ rules|length }}</span>
                <small class="text-muted">Leagues<br>Configured</small>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex flex-column">
                <span class="fs-2 text-info">
                  {% set total_fields = 0 %}
                  {% if custom_fields_by_league %}
                    {% for league_id, fields in custom_fields_by_league.items() %}
                      {% set total_fields = total_fields + fields|length %}
                    {% endfor %}
                  {% endif %}
                  {{ total_fields }}
                </span>
                <small class="text-muted">Custom<br>Fields</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Custom Field Modal -->
<div class="modal fade" id="addCustomFieldModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ph ph-plus me-2"></i>Add Custom Field
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('admin.manage_league_rules') }}">
        <input type="hidden" name="action" value="add_custom_field">
        <input type="hidden" name="league_id" id="modal_league_id">
        <div class="modal-body">
          <div class="mb-3">
            <label for="field_name" class="form-label">Field Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="field_name" name="field_name" required placeholder="e.g., Minimum Age, Maximum Squad Size">
          </div>
          <div class="mb-3">
            <label for="field_type" class="form-label">Field Type</label>
            <select class="form-select" id="field_type" name="field_type">
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="textarea">Long Text</option>
              <option value="select">Dropdown</option>
              <option value="checkbox">Checkbox</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="field_value" class="form-label">Default Value</label>
            <input type="text" class="form-control" id="field_value" name="field_value" placeholder="Optional default value">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="is_required" name="is_required">
            <label class="form-check-label" for="is_required">
              Required field
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="ph ph-plus me-1"></i>Add Field
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const leagues = {{ leagues|tojson }};
const sportConfigs = {{ sport_configs|tojson }};

function loadLeagueRules() {
    const leagueId = document.getElementById('league_id').value;
    const modalLeagueId = document.getElementById('modal_league_id');
    const customFieldsContainer = document.getElementById('customFieldsContainer');
    const noCustomFields = document.getElementById('noCustomFields');

    if (modalLeagueId) {
        modalLeagueId.value = leagueId;
    }

    if (!leagueId) {
        resetForm();
        document.getElementById('sportDefaultsInfo').classList.add('d-none');
        return;
    }

    // Get league sport and show defaults
    const league = leagues.find(l => l.id == leagueId);
    if (league && sportConfigs[leagueId]) {
        const config = sportConfigs[leagueId];
        const points = config.standings_points;

        document.getElementById('sportName').textContent = config.display_name;

        let defaultsText = `Win = ${points.win} pts`;
        if (points.draw !== undefined) {
            defaultsText += `, Draw = ${points.draw} pts`;
        }
        defaultsText += `, Loss = ${points.loss} pts`;
        if (points.overtime_win !== undefined) {
            defaultsText += `, OT Win = ${points.overtime_win} pts`;
        }
        if (points.overtime_loss !== undefined) {
            defaultsText += `, OT Loss = ${points.overtime_loss} pts`;
        }

        document.getElementById('sportDefaults').textContent = defaultsText;
        document.getElementById('sportDefaultsInfo').classList.remove('d-none');
    } else {
        document.getElementById('sportDefaultsInfo').classList.add('d-none');
    }

    // Load existing rules for selected league
    const existingRules = {{ rules|tojson }};
    const customFields = {{ custom_fields_by_league|tojson if custom_fields_by_league else '{}' }};

    const selectedRule = existingRules.find(rule => rule[0] == leagueId);
    if (selectedRule) {
        document.getElementById('points_win').value = selectedRule[2] || (sportConfigs[leagueId]?.standings_points.win || 3);
        document.getElementById('points_draw').value = selectedRule[3] || (sportConfigs[leagueId]?.standings_points.draw || 1);
        document.getElementById('points_loss').value = selectedRule[4] || (sportConfigs[leagueId]?.standings_points.loss || 0);
        document.getElementById('tiebreakers').value = selectedRule[5] || '';
        document.getElementById('substitution_limit').value = selectedRule[6] || '';
        document.getElementById('foreign_player_limit').value = selectedRule[7] || '';
        document.getElementById('notes').value = selectedRule[8] || '';
    } else if (sportConfigs[leagueId]) {
        // No existing rules - use sport defaults
        const points = sportConfigs[leagueId].standings_points;
        document.getElementById('points_win').value = points.win || 3;
        document.getElementById('points_draw').value = points.draw !== undefined ? points.draw : 1;
        document.getElementById('points_loss').value = points.loss || 0;
    }

    // Load custom fields for selected league
    const leagueCustomFields = customFields[leagueId] || [];
    customFieldsContainer.innerHTML = '';

    if (leagueCustomFields.length === 0) {
        customFieldsContainer.appendChild(noCustomFields);
    } else {
        leagueCustomFields.forEach(field => {
            const fieldHtml = createCustomFieldHTML(field);
            customFieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
        });
    }
}

function createCustomFieldHTML(field) {
    const required = field.is_required ? '<span class="text-danger">*</span>' : '';
    const fieldValue = field.field_value || '';

    let inputHtml = '';
    switch(field.field_type) {
        case 'number':
            inputHtml = `<input type="number" class="form-control" name="custom_field_${field.field_id}" value="${fieldValue}" ${field.is_required ? 'required' : ''}>`;
            break;
        case 'textarea':
            inputHtml = `<textarea class="form-control" name="custom_field_${field.field_id}" rows="2" ${field.is_required ? 'required' : ''}>${fieldValue}</textarea>`;
            break;
        case 'checkbox':
            const checked = fieldValue === 'true' || fieldValue === '1' ? 'checked' : '';
            inputHtml = `<div class="form-check">
                <input type="checkbox" class="form-check-input" name="custom_field_${field.field_id}" value="1" ${checked}>
                <label class="form-check-label">Enabled</label>
            </div>`;
            break;
        default:
            inputHtml = `<input type="text" class="form-control" name="custom_field_${field.field_id}" value="${fieldValue}" ${field.is_required ? 'required' : ''}>`;
    }

    return `
        <div class="row mb-3 custom-field-row">
            <div class="col-8">
                <label class="form-label">${field.field_name} ${required}</label>
                ${inputHtml}
            </div>
            <div class="col-4 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCustomField(${field.field_id})">
                    <i class="ph ph-trash"></i>
                </button>
            </div>
        </div>
    `;
}

function deleteCustomField(fieldId) {
    if (confirm('Are you sure you want to delete this custom field?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.manage_league_rules") }}';
        form.innerHTML = `
            <input type="hidden" name="action" value="delete_custom_field">
            <input type="hidden" name="field_id" value="${fieldId}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function loadSpecificRules(leagueId) {
    document.getElementById('league_id').value = leagueId;
    loadLeagueRules();
}

function resetForm() {
    document.getElementById('rulesForm').reset();
    document.getElementById('league_id').value = '';
    document.getElementById('customFieldsContainer').innerHTML = '';
    document.getElementById('customFieldsContainer').appendChild(document.getElementById('noCustomFields'));
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const leagueSelect = document.getElementById('league_id');
    if (leagueSelect.value) {
        loadLeagueRules();
    }
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.list-group-item-action {
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.list-group-item-action:hover {
    background-color: rgba(0, 0, 0, 0.04);
}

.custom-field-row {
    padding: 0.5rem;
    border-left: 3px solid #007bff;
    background-color: rgba(0, 123, 255, 0.04);
    margin-bottom: 0.75rem !important;
    border-radius: 0.25rem;
}

.form-control:focus,
.form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

.input-group .form-control {
    border-left: none;
}

.badge {
    font-size: 0.75em;
}

#noCustomFields {
    background-color: rgba(108, 117, 125, 0.1);
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    margin: 1rem;
}
</style>
{% endblock %}