{% extends "base.html" %}
{% block title %}Admin Dashboard - Sports League Management{% endblock %}
{% block content %}
{% macro format_currency_cents(value) -%}
{{ "$" ~ "{:,.2f}".format(((value or 0) / 100)) }}
{%- endmacro %}
{% macro render_delta(metric, previous_year, is_currency=False) -%}
    {% if not metric %}
        <span class="text-muted small">No comparison data</span>
    {% else %}
        {% set delta = metric.delta %}
        {% set pct = metric.delta_pct %}
        {% set previous = metric.previous %}
        {% if delta == 0 %}
            <span class="text-muted small">No change vs {{ previous_year }}</span>
        {% else %}
            {% set direction_class = 'text-success' if delta > 0 else 'text-danger' %}
            {% set icon = 'bi-arrow-up-right' if delta > 0 else 'bi-arrow-down-right' %}
            {% if is_currency %}
                {% set delta_display = format_currency_cents(delta) %}
                {% if delta > 0 %}
                    {% set delta_display = '+' ~ delta_display %}
                {% endif %}
            {% else %}
                {% set delta_display = delta if delta < 0 else '+' ~ delta %}
            {% endif %}
            <span class="{{ direction_class }} small">
                <i class="bi {{ icon }}"></i>
                {{ delta_display }}
                {% if pct is not none %}
                    ({{ pct|round(1) }}%)
                {% endif %}
                vs {{ previous_year }}
            </span>
        {% endif %}
    {% endif %}
{%- endmacro %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Admin Dashboard</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin.site_settings') }}" class="btn btn-outline-primary"><i class="bi bi-gear"></i> Site Settings</a>
            <a href="{{ url_for('admin.manage_navigation') }}" class="btn btn-primary"><i class="bi bi-compass"></i> Navigation</a>
        </div>
    </div>

    <ul class="nav nav-tabs" id="admin-dashboard-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab" aria-controls="overview-pane" aria-selected="true">
                Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights-pane" type="button" role="tab" aria-controls="insights-pane" aria-selected="false">
                League Insights
            </button>
        </li>
    </ul>

    <div class="tab-content pt-4" id="admin-dashboard-tab-content">
        <div class="tab-pane fade show active" id="overview-pane" role="tabpanel" aria-labelledby="overview-tab">
            <div class="row g-3">
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_users') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-people fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Users</div>
                                <small class="text-muted">Manage users & roles</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_leagues') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-trophy fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Leagues</div>
                                <small class="text-muted">Leagues & seasons</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_teams') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-shield fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Teams</div>
                                <small class="text-muted">Teams & coaches</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_players') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-person-badge fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Players</div>
                                <small class="text-muted">Rosters & profiles</small>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_matches') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-calendar-event fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Matches</div>
                                <small class="text-muted">Schedule & score</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_scores') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-clipboard-data fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Scores</div>
                                <small class="text-muted">Manage results</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.generate_fixtures') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-magic fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Generate Fixtures</div>
                                <small class="text-muted">Auto-schedule</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.recalculate_standings') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-arrow-repeat fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Recalculate</div>
                                <small class="text-muted">Standings</small>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_league_fees') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-cash-coin fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">League Fees</div>
                                <small class="text-muted">Plans &amp; installments</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_league_homepage') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-layout-text-window fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">League Homepage</div>
                                <small class="text-muted">Hero &amp; highlights</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_navigation') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-compass fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Navigation</div>
                                <small class="text-muted">Menus & layout</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_league_rules') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-sliders fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">League Rules</div>
                                <small class="text-muted">Points & tie-breakers</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_seasons') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-calendar3 fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Seasons</div>
                                <small class="text-muted">Lifecycle</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_stadiums') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-geo-alt fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Venues</div>
                                <small class="text-muted">Stadiums</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_standings') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-list-ol fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Standings</div>
                                <small class="text-muted">Table</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_scorers') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-star fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Scorers</div>
                                <small class="text-muted">Top lists</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_countries') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-flag fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Countries</div>
                                <small class="text-muted">Metadata</small>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <a class="card h-100 text-decoration-none" href="{{ url_for('admin.manage_referees') }}">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-whistle fs-3 text-primary me-3"></i>
                            <div>
                                <div class="fw-semibold">Referees</div>
                                <small class="text-muted">Officials</small>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="insights-pane" role="tabpanel" aria-labelledby="insights-tab">
            {% if insights and insights.error %}
                <div class="alert alert-warning mb-0">{{ insights.error }}</div>
            {% elif insights %}
                {% set totals = insights.totals %}
                <div class="row g-3 mb-4">
                    <div class="col-md-6 col-xl-3">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Teams {{ insights.current_year }}</span>
                                <h3 class="fw-semibold mb-1">{{ totals.teams.current }}</h3>
                                {{ render_delta(totals.teams, insights.previous_year) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Players {{ insights.current_year }}</span>
                                <h3 class="fw-semibold mb-1">{{ totals.players.current }}</h3>
                                {{ render_delta(totals.players, insights.previous_year) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Paid Registrations</span>
                                <h3 class="fw-semibold mb-1">{{ totals.paid_registrations.current }}</h3>
                                {{ render_delta(totals.paid_registrations, insights.previous_year) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Revenue {{ insights.current_year }}</span>
                                <h3 class="fw-semibold mb-1">{{ format_currency_cents(totals.revenue.current) }}</h3>
                                {{ render_delta(totals.revenue, insights.previous_year, True) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Conversion Rate</span>
                                <h3 class="fw-semibold mb-1">
                                    {% if insights.conversion_rate is not none %}
                                        {{ insights.conversion_rate|round(1) }}%
                                    {% else %}
                                        <span class="text-muted">No data</span>
                                    {% endif %}
                                </h3>
                                <p class="text-muted small mb-0">Share of registrations marked as paid this year.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Average Team Size</span>
                                <h3 class="fw-semibold mb-1">
                                    {% if insights.average_team_size %}
                                        {{ insights.average_team_size|round(1) }}
                                    {% else %}
                                        <span class="text-muted">No data</span>
                                    {% endif %}
                                </h3>
                                <p class="text-muted small mb-0">Players assigned to teams formed this year.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-lg-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <span class="text-muted text-uppercase small">Registrations {{ insights.current_year }}</span>
                                <h3 class="fw-semibold mb-1">{{ totals.registrations.current }}</h3>
                                {{ render_delta(totals.registrations, insights.previous_year) }}
                                <p class="text-muted small mb-0">Total submissions received this year.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h6 mb-0">League Breakdown ({{ insights.current_year }})</h2>
                            <small class="text-muted">Top leagues ranked by teams created this year.</small>
                        </div>
                        {% if insights.updated_at %}
                            <small class="text-muted">Updated {{ insights.updated_at.strftime('%b %d, %Y') }}</small>
                        {% endif %}
                    </div>
                    {% if insights.league_breakdown %}
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">League</th>
                                        <th scope="col" class="text-center">Teams</th>
                                        <th scope="col">YoY Change</th>
                                        <th scope="col" class="text-center">Paid Registrations</th>
                                        <th scope="col" class="text-end">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for league in insights.league_breakdown %}
                                        {% set league_metric = {
                                            'current': league.teams_current,
                                            'previous': league.teams_previous,
                                            'delta': league.team_delta,
                                            'delta_pct': league.team_delta_pct
                                        } %}
                                        <tr>
                                            <th scope="row">{{ league.name }}</th>
                                            <td class="text-center">{{ league.teams_current }}</td>
                                            <td>{{ render_delta(league_metric, insights.previous_year) }}</td>
                                            <td class="text-center">{{ league.registrations_current }}</td>
                                            <td class="text-end">{{ format_currency_cents(league.revenue_cents) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted mb-0">No league activity recorded for {{ insights.current_year }} yet.</p>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">Insights will appear once league activity has been recorded.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}






